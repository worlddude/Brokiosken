<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brokiosken App</title>

  <style>
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      margin:0;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
      background:linear-gradient(180deg,#fff7e6 0%,#fef3c7 100%);
    }

    /* Main app shell */
    .app-wrap{
      width:90%;
      max-width:400px;
      height:95vh;
      background:#fff;
      border-radius:28px;
      overflow:hidden;
      box-shadow:0 12px 40px rgba(0,0,0,0.12);
      display:flex;
      flex-direction:column;
    }

    /* LOGIN PAGE */
    .container{
      padding:48px 28px;
      text-align:center;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      height:100%;
      background:linear-gradient(180deg,#fff7e6 0%,#fef3c7 100%);
    }
    h1{
      font-size:32px;
      font-weight:800;
      color:#facc15;
      margin-bottom:18px;
      text-shadow:0 1px 1px rgba(0,0,0,0.05);
    }
    input{
      width:100%;
      max-width:320px;
      padding:14px;
      margin-bottom:12px;
      border:1px solid #fcd34d;
      border-radius:14px;
      font-size:16px;
      text-align:center;
      background:#fffbea;
      transition:border-color .2s,box-shadow .2s;
    }
    input:focus{
      border-color:#facc15;
      outline:none;
      box-shadow:0 0 0 3px rgba(250,204,21,0.3);
    }
    button{
      width:100%;
      max-width:320px;
      padding:14px;
      border:none;
      border-radius:14px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      background:#facc15;
      color:#1f2937;
      margin-bottom:10px;
      transition:transform .15s,background-color .2s;
    }
    button:hover{background:#fbbf24;transform:translateY(-1px)}
    p#status{opacity:0;transition:opacity .4s;font-size:14px;margin-top:12px;}

    /* HEADER */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 18px;
      background:#facc15;
      color:#1f2937;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .header h2{margin:0;font-weight:700;font-size:18px;}
    .header .right{display:flex;align-items:center;gap:12px;}
    .cart-btn img{width:26px;height:26px;}

    /* CONTENT */
    .content{
      flex:1;
      padding:16px;
      overflow-y:auto;
      background:#fffaf0;
    }

    /* PRODUCTS */
    .product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;}
    .product-card,.offer-card{
      background:#fff;
      border-radius:18px;
      padding:12px;
      box-shadow:0 4px 14px rgba(0,0,0,0.06);
      display:flex;
      flex-direction:column;
      align-items:center;
      transition:transform .15s,box-shadow .2s;
    }
    .product-card:hover,.offer-card:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(0,0,0,0.08);
    }
    .product-card img,.offer-card img{
      width:100%;
      height:120px;
      object-fit:cover;
      border-radius:12px;
      margin-bottom:8px;
    }
    .product-info{text-align:center;flex:1;}
    .price{font-weight:700;color:#0f172a;margin-bottom:4px;}
    .buy-btn{
      background:#facc15;
      color:#1f2937;
      border:none;
      border-radius:8px;
      padding:8px 12px;
      font-weight:700;
      cursor:pointer;
      width:100%;
      transition:background .2s;
    }
    .buy-btn:hover{background:#fbbf24;}

    /* NAV */
    .bottom-nav{
      display:flex;
      justify-content:space-around;
      background:#fff8dc;
      padding:8px 0;
      border-top:1px solid #fde68a;
    }
    .bottom-nav button{
      background:none;
      border:none;
      color:#44403c;
      font-weight:500;
      font-size:12px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      transition:color .2s,transform .15s;
    }
    .bottom-nav button img{width:24px;height:24px;opacity:.8;}
    .bottom-nav button.active{
      color:#facc15;
      transform:scale(1.08);
    }
    .bottom-nav button.active img{
      filter:drop-shadow(0 0 4px rgba(250,204,21,0.5));
      opacity:1;
    }

    /* CART */
    .cart-btn{position:relative;border:none;background:none;cursor:pointer;}
    .cart-count{
      position:absolute;
      top:-6px;
      right:-6px;
      background:#ef4444;
      color:white;
      font-size:12px;
      padding:2px 6px;
      border-radius:999px;
    }
    .cart-drawer{
      position:fixed;
      right:12px;
      bottom:72px;
      width:320px;
      max-width:calc(100% - 40px);
      background:#fff;
      border-radius:16px;
      box-shadow:0 16px 40px rgba(0,0,0,0.2);
      overflow:hidden;
      z-index:60;
      display:none;
      flex-direction:column;
      animation:slideUp .25s ease-out;
    }
    @keyframes slideUp{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
    .cart-header{
      padding:12px 14px;
      border-bottom:1px solid rgba(0,0,0,0.06);
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:#fffbea;
      font-weight:700;
    }
    .cart-list{max-height:320px;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px;}
    .cart-row{display:flex;gap:8px;align-items:center;}
    .cart-row img{width:44px;height:44px;object-fit:cover;border-radius:6px;}
    .cart-actions{
      padding:12px;
      border-top:1px solid rgba(0,0,0,0.06);
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:#fffbea;
    }
    .checkout-btn{
      background:#10b981;
      color:white;
      border:none;
      border-radius:8px;
      padding:8px 12px;
      font-weight:700;
      cursor:pointer;
    }
    .checkout-btn:hover{background:#059669;}

    .section-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .section-row h3{margin:0;color:#facc15;}

    .search-box{width:100%;display:flex;justify-content:center;margin-bottom:12px;}
    .search-box input{
      width:95%;
      padding:10px;
      border-radius:10px;
      border:1px solid #fde68a;
      text-align:center;
      background:#fff;
    }

    @media(max-width:420px){.cart-drawer{right:8px;left:8px;width:auto;}}
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div class="app-wrap" id="app">
    <div class="container" id="loginPage">
      <img src="./icons/logo.png" alt="Logo" style="width:72px;height:72px;margin-bottom:12px;">
      <h1>Brokiosken</h1>
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Adgangskode" />
      <button onclick="signupUser()">Opret bruger</button>
      <button onclick="loginUser()">Log ind</button>
      <p id="status"></p>
    </div>

    <!-- MAIN -->
    <div id="mainPage" style="display:none;flex-direction:column;height:100%;">
      <div class="header">
        <h2 id="pageTitle">Butik</h2>
        <div class="right">
          <button class="cart-btn" onclick="toggleCart()">
            <img src="./icons/cart.png" alt="Kurv">
            <span class="cart-count" id="cartCount" style="display:none;">0</span>
          </button>
        </div>
      </div>

      <div class="content" id="pageContent"></div>

      <div class="bottom-nav">
        <button data-section="news" onclick="showSection('news')">
          <img src="./icons/discount.png" alt="Tilbud">
          <span>Nyheder</span>
        </button>
        <button data-section="store" onclick="showSection('store')" class="active">
          <img src="./icons/shop.png" alt="Butik">
          <span>Butik</span>
        </button>
        <button data-section="profile" onclick="showSection('profile')">
          <img src="./icons/user.png" alt="Profil">
          <span>Profil</span>
        </button>
      </div>

      <div class="cart-drawer" id="cartDrawer">
        <div class="cart-header">
          <span>Din kurv</span>
          <button onclick="closeCart()" style="background:none;border:none;cursor:pointer;font-size:18px;">✕</button>
        </div>
        <div class="cart-list" id="cartList"></div>
        <div class="cart-actions">
          <div><strong>Total:</strong> <span id="cartTotal">0 kr</span></div>
          <button class="checkout-btn" onclick="checkout()">Køb</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT (same logic, only offers load fixed) -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const supabase = createClient(
      'https://olfvimlmyqtadzkwiibg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sZnZpbWxteXF0YWR6a3dpaWJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNDgyNTcsImV4cCI6MjA3NzcyNDI1N30.KgNwLHO7fDH1YCRb5cEc9Yo-mSNtae83B783o-0Hqr4'
    )

    /* identical functions preserved from your original */
    const status=document.getElementById('status')
    const loginPage=document.getElementById('loginPage')
    const mainPage=document.getElementById('mainPage')
    const pageContent=document.getElementById('pageContent')
    const pageTitle=document.getElementById('pageTitle')
    const cartCountEl=document.getElementById('cartCount')
    const cartDrawer=document.getElementById('cartDrawer')

    function showMessage(text,success=true){status.textContent=text;status.style.color=success?'#1f2937':'#dc2626';status.style.opacity='1';setTimeout(()=>status.style.opacity='0',4000)}
    async function signupUser(){const e=email.value.trim(),p=password.value.trim();if(!e||!p)return showMessage('Udfyld email og adgangskode.',false);const{error}=await supabase.auth.signUp({email:e,password:p});if(error)showMessage(`Fejl: ${error.message}`,false);else showMessage('✅ Bruger oprettet! Tjek din email.',true);}
    async function loginUser(){const e=email.value.trim(),p=password.value.trim();if(!e||!p)return showMessage('Udfyld email og adgangskode.',false);const{error}=await supabase.auth.signInWithPassword({email:e,password:p});if(error)showMessage(`Fejl: ${error.message}`,false);else{showMessage('✅ Du er nu logget ind!',true);setTimeout(()=>{loginPage.style.display='none';mainPage.style.display='flex';showSection('store')},600)}}
    async function logoutUser(){await supabase.auth.signOut();mainPage.style.display='none';loginPage.style.display='flex';showMessage('Du er logget ud.',true);}
    function getCart(){try{return JSON.parse(localStorage.getItem('brokiosken_cart')||'[]')}catch{return[]}}
    function saveCart(c){localStorage.setItem('brokiosken_cart',JSON.stringify(c));renderCartCount()}
    function addToCart(p){const c=getCart();const f=c.find(i=>i.id===p.id);if(f)f.qty=(f.qty||1)+1;else c.push({...p,qty:1});saveCart(c);showMessage('✅ Tilføjet til kurven')}
    function removeFromCart(id){let c=getCart().filter(i=>i.id!==id);saveCart(c);renderCart()}
    function renderCartCount(){const c=getCart(),n=c.reduce((s,i)=>s+(i.qty||0),0);cartCountEl.style.display=n?'inline-block':'none';if(n)cartCountEl.textContent=n}
    function toggleCart(){cartDrawer.style.display=cartDrawer.style.display==='flex'?'none':'flex';if(cartDrawer.style.display==='flex')renderCart()}
    function closeCart(){cartDrawer.style.display='none'}
    function renderCart(){const list=document.getElementById('cartList');const c=getCart();list.innerHTML='';let t=0;c.forEach(i=>{t+=(i.price||0)*(i.qty||1);list.innerHTML+=`<div class='cart-row'><img src='${i.image_url||"./icons/placeholder.png"}'/><div style='flex:1'><div style='font-weight:700'>${i.name}</div><div style='font-size:13px'>${i.qty} × ${i.price} kr</div></div><button style='border:none;background:none;color:#ef4444;font-weight:700' onclick="removeFromCart('${i.id}')">Fjern</button></div>`});document.getElementById('cartTotal').textContent=`${t} kr`;renderCartCount();}
    function checkout(){const c=getCart();if(!c.length)return showMessage('Din kurv er tom',false);localStorage.removeItem('brokiosken_cart');renderCartCount();renderCart();showMessage('Tak for din ordre!',true);closeCart();}
    async function resolveImageUrl(img){if(!img)return'./icons/placeholder.png';if(img.startsWith('http'))return img;try{const{data}=supabase.storage.from('product-images').getPublicUrl(img);if(data?.publicUrl)return data.publicUrl}catch{}return img}
    async function fetchProducts(){const{data,error}=await supabase.from('products').select('id,name,price,image_url');return{data:data||[],error}}
    async function fetchOffers(){const{data,error}=await supabase.from('offers').select('id,title,description,price,image_url');return{data:data||[],error}}

    function createProductCard(p){const c=document.createElement('div');c.className='product-card';c.innerHTML=`<img src='${p.image_url||"./icons/placeholder.png"}'><div class='product-info'><div style='font-weight:700'>${p.name}</div><div style='color:#64748b;font-size:13px'>${p.price} kr</div></div><button class='buy-btn' onclick='addToCart(${JSON.stringify(p)})'>Tilføj</button>`;return c;}
    function createOfferCard(o){const c=document.createElement('div');c.className='offer-card';c.innerHTML=`<img src='${o.image_url||"./icons/placeholder.png"}'><div class='product-info'><div style='font-weight:700'>${o.title}</div><div style='font-size:13px;color:#6b7280'>${o.description||''}</div><div class='price'>${o.price||''} kr</div></div><button class='buy-btn' onclick='addToCart({id:"offer-${o.id}",name:"${o.title}",price:${o.price||0},image_url:"${o.image_url}"})'>Tilføj</button>`;return c;}

    async function showSection(s){pageContent.innerHTML='';document.querySelectorAll('.bottom-nav button').forEach(b=>b.classList.remove('active'));document.querySelector(`.bottom-nav button[data-section="${s}"]`)?.classList.add('active');
      if(s==='store'){pageTitle.textContent='Butik';const box=document.createElement('div');box.className='search-box';box.innerHTML="<input id='productSearch' placeholder='Søg...'>";pageContent.appendChild(box);
        const {data:products}=await fetchProducts();await Promise.all(products.map(async p=>p.image_url=await resolveImageUrl(p.image_url)));const grid=document.createElement('div');grid.className='product-grid';products.forEach(p=>grid.appendChild(createProductCard(p)));pageContent.appendChild(grid);
        document.getElementById('productSearch').addEventListener('input',e=>{const q=e.target.value.toLowerCase();grid.querySelectorAll('.product-card').forEach(c=>{c.style.display=c.innerText.toLowerCase().includes(q)?'':'none'})});
      } else if(s==='news'){pageTitle.textContent='Nyheder';const {data:offers}=await fetchOffers();await Promise.all(offers.map(async o=>o.image_url=await resolveImageUrl(o.image_url)));const wrap=document.createElement('div');wrap.className='product-grid';offers.forEach(o=>wrap.appendChild(createOfferCard(o)));pageContent.appendChild(wrap);
      } else if(s==='profile'){pageTitle.textContent='Profil';const {data}=await supabase.auth.getUser();const u=data?.user;const email=u?.email||'';pageContent.innerHTML=`<div style='padding:12px'><h3 style='color:#facc15'>Din profil</h3><p><strong>Email:</strong> ${email}</p><p><strong>Loyalitetspoint:</strong> 120</p><button class='buy-btn' onclick='logoutUser()'>Log ud</button></div>`;}
    }

    window.signupUser=signupUser;window.loginUser=loginUser;window.logoutUser=logoutUser;window.addToCart=addToCart;window.toggleCart=toggleCart;window.closeCart=closeCart;window.removeFromCart=removeFromCart;window.checkout=checkout;window.showSection=showSection;
    (function init(){renderCartCount()})();
  </script>
</body>
</html>
