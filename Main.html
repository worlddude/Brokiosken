<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brokiosken App</title>

  <style>
    /* ---------------- Global ---------------- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root{
      --bg: #f3f6fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --brand1: #2563eb;
      --brand2: #3b82f6;
      --accent1:#06b6d4;
      --accent2:#0ea5e9;
      --success1:#10b981; --success2:#22c55e;
      --danger:#ef4444;
      --ring: rgba(37,99,235,.25);
      --border:#e2e8f0;
      --shadow: 0 10px 40px rgba(0,0,0,.12);
      --radius: 24px;
    }
    body.dark{
      --bg: #0b1220;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #cbd5e1;
      --brand1: #1e40af;
      --brand2: #2563eb;
      --accent1:#0ea5e9;
      --accent2:#38bdf8;
      --success1:#10b981; --success2:#34d399;
      --danger:#f87171;
      --ring: rgba(59,130,246,.3);
      --border:#243148;
      --shadow: 0 10px 40px rgba(0,0,0,.45);
    }
    body {
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      display: flex; justify-content: center; align-items: center;
      height: 100vh;
      background: linear-gradient(145deg, #eaf2ff, #f1f5f9);
      transition: background .35s ease;
      color: var(--text);
    }
    body.dark { background: linear-gradient(160deg, #0b1220, #0f172a); }

    /* ---------------- Shell ---------------- */
    .app-wrap{
      width: 92%;
      max-width: 430px;
      height: 95vh;
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
      transition: background .3s,color .3s, box-shadow .3s;
    }

    /* ---------------- Login ---------------- */
    .container{
      padding: 36px 24px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-align:center; height:100%;
      background: linear-gradient(160deg, #eff6ff 0%, #f9fafb 100%);
    }
    body.dark .container{ background: linear-gradient(160deg, #0f172a, #0b1220); }

    .brandlockup{
      display:flex; align-items:center; gap:12px; margin-bottom: 16px;
    }
    .logo{
      width:42px; height:42px; border-radius: 12px; display:inline-grid; place-items:center;
      background: radial-gradient(65% 65% at 30% 30%, #60a5fa, #2563eb);
      color:white; font-weight:900; letter-spacing:.5px; font-size:18px;
      box-shadow: 0 8px 18px rgba(37,99,235,.35);
    }
    h1{ margin:0; font-size: 28px; font-weight: 800; color: var(--brand2); }
    body.dark h1{ color:#93c5fd; }

    .subtle{ color: var(--muted); font-size:14px; margin-bottom: 16px; }

    input{
      width:100%; max-width:320px;
      padding: 14px 14px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: #f8fafc;
      font-size: 16px;
      margin-bottom: 12px;
      transition: box-shadow .2s, border-color .2s, background .2s, color .2s;
      color: var(--text);
    }
    body.dark input{ background:#0f172a; border-color:#1f2a44; }
    input:focus{ outline:none; border-color: var(--brand2); box-shadow: 0 0 0 3px var(--ring); }

    .btn{
      width:100%; max-width:320px; padding: 13px;
      border:none; border-radius: 12px; color:white;
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      font-weight: 700; cursor:pointer;
      transition: transform .12s, box-shadow .12s, filter .2s;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 6px 14px rgba(37,99,235,.3); }
    .btn.secondary{
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
    }
    .btn.danger{
      background: linear-gradient(90deg, var(--danger), #fb7185);
    }

    #status{ opacity:0; transition: opacity .3s; font-size: 14px; font-weight:500; margin-top: 8px; }

    /* ---------------- Header ---------------- */
    .header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 16px;
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      color:white;
      box-shadow: 0 2px 10px rgba(0,0,0,.12);
    }
    .header-title{ display:flex; align-items:center; gap:10px; }
    .header .mark{ width:28px; height:28px; border-radius:8px; display:grid; place-items:center; background:rgba(255,255,255,.2); font-weight:900; }

    .iconbtn{
      border:none; background: transparent; color:inherit; cursor:pointer; padding:6px; position:relative;
    }
    .badge{
      position:absolute; top:-4px; right:-4px;
      background:#ef4444; color:white; font-size:11px; padding:2px 6px; border-radius:999px;
      display:none;
    }

    /* ---------------- Content ---------------- */
    .content{
      flex:1; overflow-y:auto; padding: 14px;
      background: var(--bg); animation: fadeIn .25s ease;
    }

    /* ---------------- Grid & Cards (layout preserved) ---------------- */
    .product-grid{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 14px;
    }
    .product-card, .offer-card{
      background: var(--card); border-radius: 18px; padding: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,.06);
      display:flex; flex-direction:column; align-items:center;
      transition: transform .12s, box-shadow .2s, background .3s, color .3s;
    }
    .product-card:hover, .offer-card:hover{ transform: translateY(-3px); box-shadow: 0 10px 22px rgba(0,0,0,.10); }
    .product-card img, .offer-card img{
      width:100%; height: 120px; object-fit: cover; border-radius: 12px; margin-bottom: 10px; background:#e5e7eb;
    }
    .product-info{ text-align:center; flex:1; }
    .price{ font-weight:800; color:var(--text); }

    .buy-btn{
      margin-top:8px; width:100%;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      border:none; border-radius: 10px; color:white; font-weight:700; padding:8px 12px; cursor:pointer;
      transition: transform .12s, box-shadow .12s;
    }
    .buy-btn:hover{ transform: translateY(-1px); box-shadow: 0 6px 12px rgba(6,182,212,.28); }

    /* ---------------- Search ---------------- */
    .search-box{ width:100%; display:flex; justify-content:center; margin-bottom: 12px; }
    .search-box input{
      width:95%; padding: 12px 14px; border-radius: 12px; border:1px solid var(--border); background: var(--card);
    }

    /* ---------------- Section rows ---------------- */
    .section-row{ display:flex; align-items:center; justify-content:space-between; margin: 8px 2px 6px; }
    .section-row h3{ margin:0; font-size:16px; font-weight:800; color: var(--brand2); }
    body.dark .section-row h3{ color:#93c5fd; }

    /* ---------------- Bottom nav ---------------- */
    .bottom-nav{
      display:flex; justify-content:space-around; gap:2px;
      background: linear-gradient(0deg, rgba(0,0,0,.04), rgba(0,0,0,0));
      padding: 8px 0; border-top:1px solid var(--border);
      backdrop-filter: blur(6px);
    }
    .bottom-nav button{
      background:none; border:none; color: var(--muted);
      font-weight:600; font-size: 12px; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; gap:4px;
      padding: 6px 10px; border-radius: 10px;
      transition: color .2s, transform .12s, background .2s;
    }
    .bottom-nav button.active{
      color: white; transform: translateY(-1px);
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      box-shadow: 0 6px 18px rgba(37,99,235,.25);
    }
    .nav-ico{ width:24px; height:24px; display:grid; place-items:center; }

    /* ---------------- Cart drawer ---------------- */
    .cart-drawer{
      position:fixed; right:12px; bottom:72px; width: 320px; max-width: calc(100% - 40px);
      background: var(--card); border-radius: 16px; box-shadow: var(--shadow); overflow:hidden; z-index:60;
      display:none; flex-direction: column; animation: slideUp .22s ease-out;
    }
    .cart-header, .cart-actions{
      padding: 12px 14px; background: linear-gradient(0deg, rgba(0,0,0,.03), rgba(0,0,0,0));
      border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between;
    }
    .cart-actions{ border-top:1px solid var(--border); border-bottom:none; }
    .cart-list{ max-height: 320px; overflow:auto; padding: 10px; display:flex; flex-direction:column; gap:8px; }
    .cart-row{ display:flex; gap:10px; align-items:center; }
    .cart-row img{ width:44px; height:44px; object-fit:cover; border-radius: 8px; }

    .checkout-btn{
      padding: 8px 12px; border:none; border-radius: 10px; cursor:pointer;
      background: linear-gradient(90deg, var(--success1), var(--success2));
      color:white; font-weight:800; transition: transform .12s, box-shadow .12s;
    }
    .checkout-btn:hover{ transform: translateY(-1px); box-shadow: 0 6px 16px rgba(16,185,129,.35); }

    /* ---------------- Dialog (reusable) ---------------- */
    .dialog-backdrop{
      position:fixed; inset:0; background: rgba(0,0,0,.35); display:none; place-items:center; z-index:70;
    }
    .dialog{
      width: min(92vw, 380px); background: var(--card); color: var(--text); border-radius: 16px; box-shadow: var(--shadow);
      padding: 16px;
    }
    .dialog h4{ margin: 0 0 6px; }
    .dialog-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top: 10px; }
    .btn.ghost{ background: none; color: var(--brand2); border:1px solid var(--border); }
    .btn.tiny{ padding: 10px 12px; border-radius: 10px; }

    /* ---------------- Animations ---------------- */
    @keyframes slideUp{ from{ transform:translateY(16px); opacity:.0 } to{ transform:translateY(0); opacity:1 } }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    /* ---------------- Responsive ---------------- */
    @media (max-width:420px){ .cart-drawer{ right:8px; left:8px; width:auto; } }
  </style>
</head>
<body>

  <div class="app-wrap" id="app">
    <!-- LOGIN -->
    <div class="container" id="loginPage">
      <div class="brandlockup">
        <div class="logo">BK</div>
        <div>
          <h1>Brokiosken</h1>
          <div class="subtle">Log ind eller opret bruger</div>
        </div>
      </div>

      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Adgangskode" />
      <button class="btn" onclick="signupUser()">Opret bruger</button>
      <button class="btn secondary" onclick="loginUser()">Log ind</button>
      <p id="status"></p>
    </div>

    <!-- MAIN APP -->
    <div id="mainPage" style="display:none; height:100%; flex-direction:column;">
      <div class="header">
        <div class="header-title">
          <div class="mark">BK</div>
          <div>
            <div style="font-weight:800; line-height:1;">Brokiosken</div>
            <small style="opacity:.9">Velkommen!</small>
          </div>
        </div>
        <div class="right" style="display:flex; align-items:center; gap:6px;">
          <button class="iconbtn" id="cartToggle" title="Vis kurv" onclick="toggleCart()">
            <span class="badge" id="cartCount">0</span>
            <div class="nav-ico" aria-hidden="true">
              <!-- Cart icon -->
              <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle>
                <path d="M1 1h4l2.68 12.39A2 2 0 0 0 9.62 15H19a2 2 0 0 0 2-1.61l1.38-7.24H6"></path>
              </svg>
            </div>
          </button>
        </div>
      </div>

      <div class="content" id="pageContent"></div>

      <div class="bottom-nav">
        <button data-section="news" onclick="showSection('news')">
          <div class="nav-ico">
            <!-- Tag/discount icon -->
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.59 13.41 12 22l-8.59-8.59A2 2 0 0 1 3 12V5a2 2 0 0 1 2-2h7a2 2 0 0 1 1.41.59l7.18 7.18a2 2 0 0 1 0 2.82Z"/>
              <circle cx="7.5" cy="7.5" r="1.5"/>
            </svg>
          </div>
          <span>Nyheder</span>
        </button>
        <button data-section="store" onclick="showSection('store')" class="active">
          <div class="nav-ico">
            <!-- Store icon -->
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l1-5h16l1 5M3 9h18M5 22V9m14 13V9M3 22h18"/>
            </svg>
          </div>
          <span>Butik</span>
        </button>
        <button data-section="profile" onclick="showSection('profile')">
          <div class="nav-ico">
            <!-- User icon -->
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21a8 8 0 1 0-16 0"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
          </div>
          <span>Profil</span>
        </button>
      </div>

      <!-- CART DRAWER -->
      <div class="cart-drawer" id="cartDrawer">
        <div class="cart-header">
          <strong>Din kurv</strong>
          <button class="iconbtn" onclick="closeCart()" aria-label="Luk">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6 6 18M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="cart-list" id="cartList"></div>
        <div class="cart-actions">
          <div><strong>Total:</strong> <span id="cartTotal">0 kr</span></div>
          <div style="display:flex; gap:8px;">
            <button class="btn tiny ghost" onclick="clearCart()">TÃ¸m</button>
            <button class="checkout-btn" onclick="checkout()">KÃ¸b</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reusable dialog -->
  <div class="dialog-backdrop" id="dialogBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="dialog" id="dialogBox">
      <h4 id="dialogTitle">BekrÃ¦ft</h4>
      <div id="dialogBody" class="subtle">Er du sikker?</div>
      <div class="dialog-actions">
        <button class="btn tiny ghost" id="dialogCancel">Annuller</button>
        <button class="btn tiny danger" id="dialogConfirm">BekrÃ¦ft</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    /* ---------- Supabase ---------- */
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const supabase = createClient(
      'https://olfvimlmyqtadzkwiibg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sZnZpbWxteXF0YWR6a3dpaWJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNDgyNTcsImV4cCI6MjA3NzcyNDI1N30.KgNwLHO7fDH1YCRb5cEc9Yo-mSNtae83B783o-0Hqr4'
    );

    /* ---------- Elements ---------- */
    const status=document.getElementById('status');
    const loginPage=document.getElementById('loginPage');
    const mainPage=document.getElementById('mainPage');
    const pageContent=document.getElementById('pageContent');
    const cartCountEl=document.getElementById('cartCount');
    const cartDrawer=document.getElementById('cartDrawer');
    const dialogBackdrop = document.getElementById('dialogBackdrop');
    const dialogTitle = document.getElementById('dialogTitle');
    const dialogBody = document.getElementById('dialogBody');
    const dialogCancel = document.getElementById('dialogCancel');
    const dialogConfirm = document.getElementById('dialogConfirm');

    /* ---------- Utils ---------- */
    const LS_KEYS = {
      CART: 'brokiosken_cart',
      THEME: 'brokiosken_theme',
      PROFILE: 'brokiosken_profile',
      ORDERS: 'brokiosken_orders'
    };

    function showMessage(text,success=true){
      status.textContent=text;
      status.style.color=success?'#1d4ed8':'#dc2626';
      status.style.opacity='1';
      setTimeout(()=>status.style.opacity='0',3500);
    }

    function openDialog({title, body, confirmText='BekrÃ¦ft', cancelText='Annuller'}){
      dialogTitle.textContent = title;
      dialogBody.textContent = body;
      dialogConfirm.textContent = confirmText;
      dialogCancel.textContent = cancelText;
      dialogBackdrop.style.display = 'grid';
      dialogBackdrop.setAttribute('aria-hidden','false');
      return new Promise((resolve)=> {
        const onCancel = () => { cleanup(); resolve(false); };
        const onConfirm = () => { cleanup(); resolve(true); };
        function cleanup(){
          dialogBackdrop.style.display='none';
          dialogBackdrop.setAttribute('aria-hidden','true');
          dialogCancel.removeEventListener('click', onCancel);
          dialogConfirm.removeEventListener('click', onConfirm);
        }
        dialogCancel.addEventListener('click', onCancel, {once:true});
        dialogConfirm.addEventListener('click', onConfirm, {once:true});
      });
    }

    /* ---------- Auth ---------- */
    async function signupUser(){
      const email=document.getElementById('email').value.trim();
      const password=document.getElementById('password').value.trim();
      if(!email||!password) return showMessage('Udfyld email og adgangskode.',false);
      const {error} = await supabase.auth.signUp({email,password});
      if(error) showMessage(\`Fejl: \${error.message}\`, false);
      else showMessage('âœ… Bruger oprettet! Tjek din email for bekrÃ¦ftelse.', true);
    }

    async function loginUser(){
      const email=document.getElementById('email').value.trim();
      const password=document.getElementById('password').value.trim();
      if(!email||!password) return showMessage('Udfyld email og adgangskode.',false);
      const {data,error} = await supabase.auth.signInWithPassword({email,password});
      if(error){ showMessage(\`Fejl: \${error.message}\`, false); }
      else{
        showMessage('âœ… Du er nu logget ind!', true);
        setTimeout(()=>{ loginPage.style.display='none'; mainPage.style.display='flex'; showSection('store'); }, 550);
      }
    }

    async function logoutUser(){
      const ok = await openDialog({title:'Log ud', body:'Er du sikker pÃ¥ at du vil logge ud?', confirmText:'Log ud'});
      if(!ok) return;
      await supabase.auth.signOut();
      mainPage.style.display='none';
      loginPage.style.display='flex';
      showMessage('Du er logget ud.', true);
    }

    /* ---------- Local storage helpers ---------- */
    function getCart(){ try{return JSON.parse(localStorage.getItem(LS_KEYS.CART)||'[]')}catch(e){return[]} }
    function saveCart(cart){ localStorage.setItem(LS_KEYS.CART, JSON.stringify(cart)); renderCartCount(); }
    function getOrders(){ try{return JSON.parse(localStorage.getItem(LS_KEYS.ORDERS)||'[]')}catch(e){return[]} }
    function saveOrders(orders){ localStorage.setItem(LS_KEYS.ORDERS, JSON.stringify(orders)); }
    function getProfile(){ try{return JSON.parse(localStorage.getItem(LS_KEYS.PROFILE)||'{}')}catch(e){return{}} }
    function saveProfile(p){ localStorage.setItem(LS_KEYS.PROFILE, JSON.stringify(p)); }
    function setTheme(mode){ document.body.classList.toggle('dark', mode==='dark'); localStorage.setItem(LS_KEYS.THEME, mode); }
    function initTheme(){ const saved = localStorage.getItem(LS_KEYS.THEME) || 'light'; document.body.classList.toggle('dark', saved==='dark'); }

    /* ---------- Cart ---------- */
    function addToCart(product){
      const cart = getCart();
      const found = cart.find(i=>i.id===product.id);
      if(found) found.qty = (found.qty||1)+1;
      else cart.push({...product, qty:1});
      saveCart(cart);
      showMessage('âœ… TilfÃ¸jet til kurven', true);
    }
    function removeFromCart(productId){
      const cart = getCart().filter(i=>i.id!==productId);
      saveCart(cart);
      renderCart();
    }
    function clearCart(){
      saveCart([]);
      renderCart();
      showMessage('Kurven er tom.', true);
    }
    function renderCartCount(){
      const cart = getCart();
      const totalQty = cart.reduce((s,i)=>s+(i.qty||0),0);
      if(totalQty>0){
        cartCountEl.style.display='inline-block';
        cartCountEl.textContent = totalQty;
      }else{
        cartCountEl.style.display='none';
      }
    }
    function toggleCart(){ if(cartDrawer.style.display==='flex') closeCart(); else openCart(); }
    function openCart(){ renderCart(); cartDrawer.style.display='flex'; }
    function closeCart(){ cartDrawer.style.display='none'; }
    function renderCart(){
      const cartList=document.getElementById('cartList');
      const cart=getCart();
      cartList.innerHTML='';
      let total=0;
      cart.forEach(item=>{
        total += (item.price||0)*(item.qty||1);
        const row=document.createElement('div');
        row.className='cart-row';
        row.innerHTML = \`
          <img src="\${item.image_url||placeholderImg()}" alt="\${item.name}" />
          <div style="flex:1;min-width:0">
            <div style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">\${item.name}</div>
            <div class="subtle">\${item.qty} Ã— \${item.price} kr</div>
          </div>
          <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end">
            <button class="btn tiny danger" onclick="removeFromCart('\${item.id}')">Fjern</button>
          </div>\`;
        cartList.appendChild(row);
      });
      document.getElementById('cartTotal').textContent = \`\${total} kr\`;
      renderCartCount();
    }

    /* ---------- Checkout -> Order History ---------- */
    function checkout(){
      const cart=getCart();
      if(!cart.length) return showMessage('Din kurv er tom', false);
      const total = cart.reduce((s,i)=>s + (i.price||0)*(i.qty||1), 0);
      const order = {
        id: 'ord_' + Math.random().toString(36).slice(2,10),
        createdAt: new Date().toISOString(),
        items: cart.map(c=>({id: c.id, name: c.name, price: c.price, qty: c.qty, image_url: c.image_url||null})),
        total
      };
      const orders = getOrders();
      orders.unshift(order);
      saveOrders(orders);

      localStorage.removeItem(LS_KEYS.CART);
      renderCartCount(); renderCart();
      showMessage('Tak! Din ordre er modtaget.', true);
      closeCart();
    }

    /* ---------- Data ---------- */
    async function resolveImageUrl(imageField){
      if(!imageField) return placeholderImg();
      if(imageField.startsWith('http')) return imageField;
      try{
        const {data} = supabase.storage.from('product-images').getPublicUrl(imageField);
        if(data && data.publicUrl) return data.publicUrl;
      }catch(e){ console.warn('resolveImageUrl error', e); }
      return imageField;
    }
    async function fetchProducts(){
      const {data, error} = await supabase.from('products').select('id,name,price,image_url');
      if(error){ console.error('Products fetch error', error); return {error, data: []} }
      return {data: data||[], error: null};
    }
    async function fetchOffers(){
      const {data, error} = await supabase.from('offers').select('id,title,description,price,image_url');
      if(error || !data){
        return [{id:1,title:'ðŸŽ‰ 2x Kaffe To Go - kun 40 kr!',description:'',price:40},{id:2,title:'ðŸ¥ª Ny sandwich: Kylling & Bacon',description:'',price:45}]
      }
      return data;
    }

    /* ---------- UI Builders (layout preserved) ---------- */
    function createProductCard(p){
      const card=document.createElement('div');
      card.className='product-card';
      const img=document.createElement('img');
      img.src = p.image_url || placeholderImg();
      img.alt = p.name;
      const info=document.createElement('div');
      info.className='product-info';
      info.innerHTML = \`
        <div style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">\${p.name}</div>
        <div class="subtle">Produkt-id: \${p.id}</div>\`;
      const actions=document.createElement('div');
      actions.className='product-actions';
      const priceEl=document.createElement('div');
      priceEl.className='price';
      priceEl.textContent=\`\${p.price} kr\`;
      const buyBtn=document.createElement('button');
      buyBtn.className='buy-btn';
      buyBtn.textContent='TilfÃ¸j';
      buyBtn.onclick=()=>addToCart({id:String(p.id),name:p.name,price:Number(p.price)||0,image_url:p.image_url});
      actions.appendChild(priceEl); actions.appendChild(buyBtn);
      card.appendChild(img); card.appendChild(info); card.appendChild(actions);
      return card;
    }

    function createOfferCard(o){
      const card=document.createElement('div'); card.className='offer-card';
      const left=document.createElement('div');
      left.style.display='flex'; left.style.gap='10px'; left.style.alignItems='center'; left.style.flex='1'; left.style.minWidth='0';
      const img=document.createElement('img');
      img.src=o.image_url||placeholderImg(); img.alt=o.title;
      img.style.width='64px'; img.style.height='64px'; img.style.objectFit='cover'; img.style.borderRadius='8px';
      const info=document.createElement('div'); info.style.display='flex'; info.style.flexDirection='column'; info.style.gap='4px'; info.style.minWidth='0';
      info.innerHTML=\`<div style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">\${o.title||o.name}</div><div class="subtle" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">\${o.description||''}</div>\`;
      left.appendChild(img); left.appendChild(info);
      const right=document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end'; right.style.gap='8px';
      const priceEl=document.createElement('div'); priceEl.className='price'; priceEl.textContent = (o.price!==undefined&&o.price!==null)?\`\${Number(o.price)} kr\`:'';
      const addBtn=document.createElement('button'); addBtn.className='buy-btn'; addBtn.textContent='TilfÃ¸j';
      addBtn.onclick=()=>addToCart({id:\`offer-\${o.id}\`,name:o.title||o.name||\`Tilbud \${o.id}\`,price:Number(o.price)||0,image_url:o.image_url||null});
      right.appendChild(priceEl); right.appendChild(addBtn);
      card.appendChild(left); card.appendChild(right);
      return card;
    }

    /* ---------- Sections ---------- */
    async function showSection(section){
      pageContent.innerHTML='';
      document.querySelectorAll('.bottom-nav button').forEach(btn=>btn.classList.remove('active'));
      const activeBtn=document.querySelector(\`.bottom-nav button[data-section="\${section}"]\`);
      if(activeBtn) activeBtn.classList.add('active');

      if(section==='store'){
        const top = document.createElement('div');
        top.className='section-row';
        top.innerHTML = '<h3>Butik</h3>';
        pageContent.appendChild(top);

        const searchWrap=document.createElement('div');
        searchWrap.className='search-box';
        searchWrap.innerHTML="<input type='text' id='productSearch' placeholder='SÃ¸g efter produkter...' />";
        pageContent.appendChild(searchWrap);

        const spinner=document.createElement('div');
        spinner.textContent='Henter produkterâ€¦';
        spinner.className='subtle';
        pageContent.appendChild(spinner);

        const {data:products} = await fetchProducts();
        pageContent.removeChild(spinner);

        if(!products||products.length===0){
          const empty = document.createElement('div');
          empty.style.padding='12px'; empty.style.textAlign='center'; empty.className='subtle';
          empty.textContent='Ingen produkter fundet.';
          pageContent.appendChild(empty);
          return;
        }

        await Promise.all(products.map(async p=>{
          if(p.image_url && !p.image_url.startsWith('http')) p.image_url = await resolveImageUrl(p.image_url);
          p.price = Number(p.price)||0;
          p.id = p.id!==undefined ? p.id : Math.random().toString(36).slice(2,9);
          p.name = p.name || \`Produkt \${p.id}\`;
        }));

        const grid=document.createElement('div'); grid.className='product-grid';
        products.forEach(p=> grid.appendChild(createProductCard(p)));
        pageContent.appendChild(grid);

        document.getElementById('productSearch').addEventListener('input', (e)=>{
          const q = e.target.value.toLowerCase().trim();
          const filtered = products.filter(p => (p.name||'').toLowerCase().includes(q));
          const newGrid=document.createElement('div'); newGrid.className='product-grid';
          filtered.forEach(p=> newGrid.appendChild(createProductCard(p)));
          const oldGrid=pageContent.querySelector('.product-grid');
          if(oldGrid) oldGrid.replaceWith(newGrid);
        });
      }

      else if(section==='news'){
        const newsHeader=document.createElement('div');
        newsHeader.className='section-row';
        newsHeader.innerHTML='<h3>Nyheder</h3>';
        pageContent.appendChild(newsHeader);

        const newsContainer=document.createElement('div');
        newsContainer.style.display='flex'; newsContainer.style.flexDirection='column'; newsContainer.style.gap='10px';

        const exampleNews=[
          {id:'n1',title:'Ã…bningstider i dag',text:'Vi har Ã¥bent kl. 07-20'},
          {id:'n2',title:'Nye produkter',text:'Se vores nye sandwich i butikken'}
        ];
        exampleNews.forEach(n=>{
          const card=document.createElement('div'); card.className='offer-card'; card.style.alignItems='flex-start';
          card.innerHTML=\`<div style="font-weight:800">\${n.title}</div><div class="subtle">\${n.text}</div>\`;
          newsContainer.appendChild(card);
        });
        pageContent.appendChild(newsContainer);

        const offersHeader=document.createElement('div');
        offersHeader.className='section-row'; offersHeader.innerHTML='<h3>Tilbud</h3>';
        pageContent.appendChild(offersHeader);

        const offers=await fetchOffers();
        const offersWrap=document.createElement('div');
        offersWrap.style.display='flex'; offersWrap.style.flexDirection='column'; offersWrap.style.gap='8px';
        if(!offers||offers.length===0){
          const noOffers=document.createElement('div'); noOffers.style.padding='8px'; noOffers.className='subtle'; noOffers.textContent='Ingen tilbud fundet.'; offersWrap.appendChild(noOffers);
        }else{
          await Promise.all(offers.map(async o=>{ if(o.image_url && !o.image_url.startsWith('http')) o.image_url = await resolveImageUrl(o.image_url); }));
          offers.forEach(o=> offersWrap.appendChild(createOfferCard(o)));
        }
        pageContent.appendChild(offersWrap);
      }

      else if(section==='profile'){
        const top=document.createElement('div');
        top.className='section-row';
        top.innerHTML = '<h3>Profil & Indstillinger</h3>';
        pageContent.appendChild(top);

        const userResp = await supabase.auth.getUser();
        const user = userResp?.data ? userResp.data.user : null;
        const email = (user && user.email) || document.getElementById('email').value || '';

        /* --- Profile form --- */
        const profile = getProfile();
        const wrap=document.createElement('div');
        wrap.className='offer-card';
        wrap.style.alignItems='stretch';
        wrap.innerHTML = \`
          <div style="display:grid; gap:10px;">
            <div><strong>Email:</strong> \${email || '<span class="subtle">Ikke angivet</span>'}</div>
            <label style="display:grid; gap:6px;">
              <span>Navn</span>
              <input id="profileName" placeholder="Fx. Anna Hansen" value="\${profile.name||''}">
            </label>
            <label style="display:grid; gap:6px;">
              <span>Telefon</span>
              <input id="profilePhone" placeholder="+45 12 34 56 78" value="\${profile.phone||''}">
            </label>
            <div style="display:flex; gap:8px; justify-content:flex-end;">
              <button class="btn tiny ghost" id="btnResetProfile">Nulstil</button>
              <button class="btn tiny" id="btnSaveProfile">Gem profil</button>
            </div>
          </div>
        \`;
        pageContent.appendChild(wrap);

        /* --- Theme toggle --- */
        const themeCard=document.createElement('div');
        themeCard.className='offer-card';
        themeCard.style.alignItems='stretch';
        const savedTheme = localStorage.getItem(LS_KEYS.THEME) || 'light';
        themeCard.innerHTML = \`
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div>
              <div style="font-weight:800">Tema</div>
              <div class="subtle">Skift mellem lys og mÃ¸rk tilstand</div>
            </div>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" id="darkToggle" \${savedTheme==='dark'?'checked':''}>
              <span>ðŸŒ™</span>
            </label>
          </div>\`;
        pageContent.appendChild(themeCard);

        /* --- Order history --- */
        const ordersHeader=document.createElement('div');
        ordersHeader.className='section-row'; ordersHeader.innerHTML='<h3>Dine ordrer</h3>';
        pageContent.appendChild(ordersHeader);

        const ordersWrap=document.createElement('div'); ordersWrap.style.display='grid'; ordersWrap.style.gap='8px';
        const orders = getOrders();
        if(!orders.length){
          const empty=document.createElement('div'); empty.className='offer-card'; empty.innerHTML='<div class="subtle">Ingen ordrer endnu. KÃ¸b noget i butikken for at se din ordrehistorik her.</div>';
          ordersWrap.appendChild(empty);
        } else {
          orders.forEach(o=>{
            const d = new Date(o.createdAt);
            const card=document.createElement('div'); card.className='offer-card'; card.style.alignItems='stretch';
            const itemsPreview = o.items.map(i=>\`\${i.qty}Ã— \${i.name}\`).slice(0,3).join(', ') + (o.items.length>3?' â€¦':'');
            card.innerHTML = \`
              <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                <div>
                  <div style="font-weight:800">Ordre \${o.id}</div>
                  <div class="subtle">\${d.toLocaleDateString('da-DK', {year:'numeric',month:'short',day:'numeric', hour:'2-digit', minute:'2-digit'})}</div>
                  <div class="subtle" style="margin-top:4px">\${itemsPreview}</div>
                </div>
                <div style="text-align:right">
                  <div style="font-weight:800">\${o.total} kr</div>
                  <button class="btn tiny ghost" onclick='showOrder("\${o.id}")'>Detaljer</button>
                </div>
              </div>\`;
            ordersWrap.appendChild(card);
          });
        }
        pageContent.appendChild(ordersWrap);

        // Wire up profile actions
        document.getElementById('btnSaveProfile').addEventListener('click', ()=>{
          const name = (document.getElementById('profileName').value || '').trim();
          const phone = (document.getElementById('profilePhone').value || '').trim();
          saveProfile({name, phone});
          showMessage('âœ… Profil gemt', true);
        });
        document.getElementById('btnResetProfile').addEventListener('click', ()=>{
          document.getElementById('profileName').value = '';
          document.getElementById('profilePhone').value = '';
          saveProfile({});
          showMessage('Profil nulstillet', true);
        });

        // Theme toggle persist
        document.getElementById('darkToggle').addEventListener('change', (e)=>{
          setTheme(e.target.checked ? 'dark' : 'light');
        });

        // Logout button
        const logoutBlock=document.createElement('div');
        logoutBlock.style.marginTop='10px';
        logoutBlock.innerHTML='<button class="btn tiny danger" onclick="logoutUser()">Log ud</button>';
        pageContent.appendChild(logoutBlock);
      }
    }

    // Show order details in dialog
    window.showOrder = (orderId)=>{
      const o = getOrders().find(x=>x.id===orderId);
      if(!o) return;
      const list = o.items.map(i=>\`â€¢ \${i.qty}Ã— \${i.name} â€” \${i.price} kr\`).join('\\n');
      openDialog({
        title: \`Ordre \${o.id}\`,
        body: \`\${new Date(o.createdAt).toLocaleString('da-DK')}\n\${list}\nTotal: \${o.total} kr\`,
        confirmText:'Luk',
        cancelText:''
      }).then(()=>{});
      // Hide cancel if empty text
      dialogCancel.style.display='none';
      setTimeout(()=>dialogCancel.style.display='', 300); // reset after close
    };

    /* ---------- Placeholders & helpers ---------- */
    function placeholderImg(){
      // subtle gray gradient placeholder as data URI SVG
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="600" height="400">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#e5e7eb"/><stop offset="1" stop-color="#cbd5e1"/>
            </linearGradient>
          </defs>
          <rect fill="url(#g)" width="100%" height="100%"/>
          <g fill="#94a3b8" font-family="Inter,Arial" font-size="28">
            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">Billede</text>
          </g>
        </svg>`);
    }

    /* ---------- Expose ---------- */
    window.signupUser=signupUser;
    window.loginUser=loginUser;
    window.logoutUser=logoutUser;
    window.showSection=showSection;
    window.addToCart=addToCart;
    window.toggleCart=toggleCart;
    window.openCart=openCart;
    window.closeCart=closeCart;
    window.removeFromCart=removeFromCart;
    window.checkout=checkout;
    window.clearCart=clearCart;

    /* ---------- Init ---------- */
    (function init(){
      initTheme();
      renderCartCount();
    })();

  </script>
</body>
</html>
