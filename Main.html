<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Brokiosken ‚Äì App</title>

  <!-- Inter font for consistent look with login page -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ---------------- Theme ---------------- */
    :root{
      --bg-grad: linear-gradient(145deg, #eaf2ff, #f1f5f9);
      --card: rgba(255,255,255,0.85);
      --text: #0f172a;
      --muted:#64748b;
      --brand1:#2563eb;
      --brand2:#3b82f6;
      --accent1:#06b6d4;
      --accent2:#0ea5e9;
      --success1:#10b981; --success2:#22c55e;
      --danger:#ef4444;
      --border: rgba(17,24,39,.08);
      --ring: rgba(59,130,246,.25);
      --shadow: 0 10px 40px rgba(0,0,0,.12);
      --radius:24px;
    }

    @media (prefers-color-scheme: dark) {
      :root{
        --bg-grad: linear-gradient(160deg, #0b1220, #111827);
        --card: rgba(17,24,39,0.88);
        --text:#e5e7eb;
        --muted:#94a3b8;
        --brand1:#1e3a8a; --brand2:#2563eb;
        --accent1:#0ea5e9; --accent2:#38bdf8;
        --success1:#10b981; --success2:#34d399;
        --danger:#f87171;
        --border: rgba(255,255,255,.08);
        --ring: rgba(59,130,246,.35);
        --shadow: 0 10px 50px rgba(0,0,0,.4);
      }
    }

    /* ---------------- Base ---------------- */
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background: var(--bg-grad);
      color: var(--text);
      display:flex; align-items:center; justify-content:center;
    }

    /* ---------------- App shell ---------------- */
    .app-wrap{
      width:92%;
      max-width:430px;
      height:95vh;
      background: var(--card);
      backdrop-filter: blur(18px);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
      animation: fadeIn .45s ease;
    }

    /* Header */
    .header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 16px;
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      color:#fff;
      box-shadow: 0 2px 10px rgba(0,0,0,.12);
    }
    .htitle{ display:flex; align-items:center; gap:10px; }
    .mark{
      width:28px; height:28px; border-radius:8px;
      display:grid; place-items:center; font-weight:900;
      background: rgba(255,255,255,.2);
    }
    .header h2{ margin:0; font-size:18px; font-weight:800; }

    .iconbtn{ background:none; border:none; color:inherit; cursor:pointer; position:relative; padding:6px; }
    .badge{ position:absolute; top:-4px; right:-4px; background:#ef4444; color:#fff; font-size:11px; padding:2px 6px; border-radius:999px; display:none; }

    /* Content */
    .content{ flex:1; overflow-y:auto; padding:14px; background: transparent; }

    .section-row{ display:flex; align-items:center; justify-content:space-between; margin: 6px 2px 10px; }
    .section-row h3{ margin:0; font-size:16px; font-weight:800; background:linear-gradient(90deg,var(--brand1),var(--brand2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    /* Search */
    .search-box{ width:100%; display:flex; justify-content:center; margin-bottom:12px; }
    .search-box input{
      width:96%; padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background: rgba(255,255,255,.7); color:var(--text); outline:none;
      transition: box-shadow .2s, border-color .2s;
    }
    .search-box input:focus{ box-shadow:0 0 0 3px var(--ring); border-color:transparent; }

    /* Grid & Cards (layout preserved) */
    .product-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:14px; }
    .product-card,.offer-card{
      background: rgba(255,255,255,.85);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: 0 2px 12px rgba(0,0,0,.06);
      backdrop-filter: blur(10px);
      padding:12px; display:flex; flex-direction:column; align-items:center;
      transition: transform .12s, box-shadow .2s, background .3s;
    }
    .product-card:hover,.offer-card:hover{ transform:translateY(-3px); box-shadow:0 10px 22px rgba(0,0,0,.12); }
    .product-card img,.offer-card img{ width:100%; height:120px; object-fit:cover; border-radius:12px; margin-bottom:10px; background:#e5e7eb; }
    .product-info{ text-align:center; flex:1; }
    .price{ font-weight:800; }

    .buy-btn{
      margin-top:8px; width:100%;
      border:none; border-radius:10px; color:#fff; font-weight:800; padding:8px 12px; cursor:pointer;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      transition: transform .12s, box-shadow .12s;
    }
    .buy-btn:hover{ transform:translateY(-1px); box-shadow:0 8px 16px rgba(6,182,212,.28); }

    /* Bottom nav */
    .bottom-nav{
      display:flex; justify-content:space-around; gap:2px;
      padding:8px 0; border-top:1px solid var(--border); background: rgba(255,255,255,.55); backdrop-filter: blur(8px);
    }
    .bottom-nav button{
      background:none; border:none; color:var(--muted); font-weight:700; font-size:12px; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; gap:4px; padding:6px 10px; border-radius:10px; transition: transform .12s, background .2s, color .2s;
    }
    .bottom-nav button.active{
      color:#fff; transform: translateY(-1px);
      background: linear-gradient(90deg,var(--brand1),var(--brand2));
      box-shadow: 0 8px 18px rgba(37,99,235,.25);
    }
    .nav-ico{ width:24px; height:24px; display:grid; place-items:center; }

    /* Cart drawer */
    .cart-drawer{
      position:fixed; right:12px; bottom:72px; width:320px; max-width:calc(100% - 40px);
      background: var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow);
      display:none; flex-direction:column; overflow:hidden; z-index:60; animation: fadeIn .25s ease;
    }
    .cart-header,.cart-actions{ padding:12px 14px; display:flex; align-items:center; justify-content:space-between; background: rgba(255,255,255,.5); border-bottom:1px solid var(--border); }
    .cart-actions{ border-top:1px solid var(--border); border-bottom:none; }
    .cart-list{ padding:10px; max-height:320px; overflow:auto; display:flex; flex-direction:column; gap:8px; }
    .cart-row{ display:flex; gap:10px; align-items:center; }
    .cart-row img{ width:44px; height:44px; object-fit:cover; border-radius:8px; }
    .checkout-btn{ padding:8px 12px; border:none; border-radius:10px; cursor:pointer; color:#fff; font-weight:800; background: linear-gradient(90deg,var(--success1),var(--success2)); }

    /* Dialog */
    .dialog-backdrop{ position:fixed; inset:0; background: rgba(0,0,0,.35); display:none; place-items:center; z-index:80; }
    .dialog{ width:min(92vw,380px); background: var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px; }
    .dialog h4{ margin:0 0 6px; }
    .dialog .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
    .btn{ padding:10px 12px; border:none; border-radius:10px; cursor:pointer; font-weight:800; }
    .btn.primary{ background: linear-gradient(90deg,var(--brand1),var(--brand2)); color:#fff; }
    .btn.ghost{ background:none; border:1px solid var(--border); color:var(--text); }
    .btn.danger{ background: linear-gradient(90deg,var(--danger),#fb7185); color:#fff; }

    /* Toast */
    .toast{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:rgba(17,24,39,.85); color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; box-shadow:0 6px 18px rgba(0,0,0,.25); opacity:0; transition:opacity .25s; z-index:90;}

    /* Responsive */
    @media (max-width:420px){ .cart-drawer{left:8px; right:8px; width:auto;} }

    @keyframes fadeIn{ from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:translateY(0);} }
  </style>
</head>
<body>
  <div class="app-wrap" id="app">
    <!-- Header -->
    <div class="header">
      <div class="htitle">
        <div class="mark">BK</div>
        <h2 id="pageTitle">Butik</h2>
      </div>
      <button class="iconbtn" id="cartToggle" title="Vis kurv">
        <span class="badge" id="cartCount">0</span>
        <div class="nav-ico" aria-hidden="true">üõí</div>
      </button>
    </div>

    <!-- Content -->
    <div class="content" id="pageContent"></div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
      <button data-section="news" onclick="showSection('news')">
        <div class="nav-ico">üè∑Ô∏è</div>
        <span>Nyheder</span>
      </button>
      <button data-section="store" class="active" onclick="showSection('store')">
        <div class="nav-ico">üè™</div>
        <span>Butik</span>
      </button>
      <button data-section="profile" onclick="showSection('profile')">
        <div class="nav-ico">üë§</div>
        <span>Profil</span>
      </button>
    </div>

    <!-- Cart Drawer -->
    <div class="cart-drawer" id="cartDrawer">
      <div class="cart-header">
        <strong>Din kurv</strong>
        <button class="iconbtn" onclick="closeCart()">‚úï</button>
      </div>
      <div class="cart-list" id="cartList"></div>
      <div class="cart-actions">
        <div><strong>Total:</strong> <span id="cartTotal">0 kr</span></div>
        <div style="display:flex; gap:8px;">
          <button class="btn ghost" onclick="clearCart()">T√∏m</button>
          <button class="checkout-btn" onclick="checkout()">K√∏b</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dialog -->
  <div class="dialog-backdrop" id="dialogBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="dialog">
      <h4 id="dialogTitle">Bekr√¶ft</h4>
      <div id="dialogBody" class="muted">Er du sikker?</div>
      <div class="actions">
        <button class="btn ghost" id="dialogCancel">Annuller</button>
        <button class="btn danger" id="dialogConfirm">Bekr√¶ft</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Supabase (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ================== CONFIG ================== */
    const LOGIN_PAGE_URL = "https://worlddude.github.io/Brokiosken/Login.html"; // üîÅ CHANGE THIS
    const supabase = window.supabase.createClient(
      "https://olfvimlmyqtadzkwiibg.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sZnZpbWxteXF0YWR6a3dpaWJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNDgyNTcsImV4cCI6MjA3NzcyNDI1N30.KgNwLHO7fDH1YCRb5cEc9Yo-mSNtae83B783o-0Hqr4"
    );

    /* ================== ELEMENTS ================== */
    const pageContent = document.getElementById('pageContent');
    const pageTitle   = document.getElementById('pageTitle');
    const cartDrawer  = document.getElementById('cartDrawer');
    const cartList    = document.getElementById('cartList');
    const cartTotalEl = document.getElementById('cartTotal');
    const cartCountEl = document.getElementById('cartCount');
    const cartToggle  = document.getElementById('cartToggle');
    const dialogBackdrop = document.getElementById('dialogBackdrop');
    const dialogTitle = document.getElementById('dialogTitle');
    const dialogBody  = document.getElementById('dialogBody');
    const dialogCancel= document.getElementById('dialogCancel');
    const dialogConfirm= document.getElementById('dialogConfirm');
    const toastEl     = document.getElementById('toast');

    /* ================== HELPERS ================== */
    const LS = {
      CART: 'brokiosken_cart',
      PROFILE: 'brokiosken_profile',
      ORDERS: 'brokiosken_orders'
    };

    function toast(msg, ok=true){
      toastEl.textContent = msg;
      toastEl.style.background = ok ? 'rgba(16,185,129,.92)' : 'rgba(239,68,68,.92)';
      toastEl.style.opacity = '1';
      setTimeout(()=>toastEl.style.opacity='0', 2400);
    }

    function openDialog({title='Bekr√¶ft', body='Er du sikker?', confirmText='Bekr√¶ft', cancelText='Annuller'}){
      dialogTitle.textContent = title;
      dialogBody.textContent = body;
      dialogConfirm.textContent = confirmText;
      dialogCancel.textContent  = cancelText;
      dialogBackdrop.style.display = 'grid';
      dialogBackdrop.setAttribute('aria-hidden','false');
      return new Promise((resolve)=>{
        const onCancel = ()=>{ cleanup(); resolve(false); };
        const onConfirm= ()=>{ cleanup(); resolve(true); };
        function cleanup(){
          dialogBackdrop.style.display = 'none';
          dialogBackdrop.setAttribute('aria-hidden','true');
          dialogCancel.removeEventListener('click', onCancel);
          dialogConfirm.removeEventListener('click', onConfirm);
        }
        dialogCancel.addEventListener('click', onCancel, {once:true});
        dialogConfirm.addEventListener('click', onConfirm, {once:true});
      });
    }

    /* ================== AUTH GUARD ================== */
    (async function guard(){
      try{
        const { data: { user } } = await supabase.auth.getUser();
        if(!user){ window.location.href = LOGIN_PAGE_URL; return; }
        init(); // only init when logged in
      }catch(e){
        // if anything fails, fail-safe redirect
        window.location.href = LOGIN_PAGE_URL;
      }
    })();

    /* ================== DATA (Supabase) ================== */
    async function resolveImageUrl(imageField){
      if(!imageField) return placeholderImg();
      if(imageField.startsWith('http')) return imageField;
      try{
        const { data } = supabase.storage.from('product-images').getPublicUrl(imageField);
        if(data && data.publicUrl) return data.publicUrl;
      }catch(e){ console.warn('resolveImageUrl error', e); }
      return imageField;
    }

    async function fetchProducts(){
      const { data, error } = await supabase.from('products').select('id,name,price,image_url');
      if(error){ console.error('Products fetch error', error); return { error, data: [] }; }
      return { data: data||[], error: null };
    }

    async function fetchOffers(){
      const { data, error } = await supabase.from('offers').select('id,title,description,price,image_url');
      if(error || !data){
        return [{id:1,title:'üéâ 2x Kaffe To Go - kun 40 kr!',description:'',price:40},{id:2,title:'ü•™ Ny sandwich: Kylling & Bacon',description:'',price:45}];
      }
      return data;
    }

    /* ================== CART ================== */
    function getCart(){ try{return JSON.parse(localStorage.getItem(LS.CART)||'[]')}catch(_){return[]} }
    function saveCart(cart){ localStorage.setItem(LS.CART, JSON.stringify(cart)); renderCartCount(); }
    function addToCart(product){
      const cart = getCart();
      const found = cart.find(i=>i.id===product.id);
      if(found) found.qty = (found.qty||1)+1; else cart.push({...product, qty:1});
      saveCart(cart); toast('‚úÖ Tilf√∏jet til kurven', true);
    }
    function removeFromCart(id){
      const cart = getCart().filter(i=>i.id!==id);
      saveCart(cart); renderCart(); 
    }
    function clearCart(){ saveCart([]); renderCart(); toast('Kurven er tom.', true); }

    function renderCartCount(){
      const totalQty = getCart().reduce((s,i)=>s+(i.qty||0),0);
      if(totalQty>0){ cartCountEl.style.display='inline-block'; cartCountEl.textContent= totalQty; }
      else { cartCountEl.style.display='none'; }
    }
    function renderCart(){
      const cart = getCart();
      cartList.innerHTML = '';
      let total = 0;
      cart.forEach(item=>{
        total += (item.price||0)*(item.qty||1);
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
          <img src="${item.image_url||placeholderImg()}" alt="${item.name}" />
          <div style="flex:1;min-width:0">
            <div style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${item.name}</div>
            <div class="muted" style="font-size:13px">${item.qty} √ó ${item.price} kr</div>
          </div>
          <button class="btn danger" style="padding:6px 10px" onclick="removeFromCart('${item.id}')">Fjern</button>
        `;
        cartList.appendChild(row);
      });
      cartTotalEl.textContent = `${total} kr`;
      renderCartCount();
    }
    function toggleCart(){ cartDrawer.style.display = cartDrawer.style.display==='flex' ? 'none' : 'flex'; if(cartDrawer.style.display==='flex') renderCart(); }
    function closeCart(){ cartDrawer.style.display='none'; }

    /* ================== ORDERS ================== */
    function getOrders(){ try{return JSON.parse(localStorage.getItem(LS.ORDERS)||'[]')}catch(_){return[]} }
    function saveOrders(o){ localStorage.setItem(LS.ORDERS, JSON.stringify(o)); }
    function checkout(){
      const cart = getCart();
      if(!cart.length) return toast('Din kurv er tom', false);
      const total = cart.reduce((s,i)=>s + (i.price||0)*(i.qty||1),0);
      const order = {
        id: 'ord_' + Math.random().toString(36).slice(2,10),
        createdAt: new Date().toISOString(),
        items: cart.map(c=>({id:c.id, name:c.name, price:c.price, qty:c.qty, image_url:c.image_url||null})),
        total
      };
      const orders = getOrders();
      orders.unshift(order);
      saveOrders(orders);
      localStorage.removeItem(LS.CART);
      renderCart();
      toast('Tak! Din ordre er modtaget.', true);
      closeCart();
    }

    window.removeFromCart = removeFromCart;
    window.clearCart = clearCart;
    window.checkout = checkout;
    window.closeCart = closeCart;

    cartToggle.addEventListener('click', toggleCart);

    /* ================== UI BUILDERS ================== */
    function createProductCard(p){
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <img src="${p.image_url||placeholderImg()}" alt="${p.name}">
        <div class="product-info">
          <div style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name}</div>
          <div class="muted" style="font-size:13px">Produkt-id: ${p.id}</div>
          <div class="price">${p.price} kr</div>
        </div>
      `;
      const btn = document.createElement('button');
      btn.className = 'buy-btn';
      btn.textContent = 'Tilf√∏j';
      btn.onclick = ()=> addToCart({ id:String(p.id), name:p.name, price:Number(p.price)||0, image_url:p.image_url });
      card.appendChild(btn);
      return card;
    }

    function createOfferCard(o){
      const card = document.createElement('div'); card.className='offer-card';
      const left = document.createElement('div');
      left.style.display='flex'; left.style.gap='10px'; left.style.alignItems='center'; left.style.flex='1'; left.style.minWidth='0';
      const img = document.createElement('img');
      img.src = o.image_url || placeholderImg(); img.alt = o.title;
      img.style.width='64px'; img.style.height='64px'; img.style.objectFit='cover'; img.style.borderRadius='8px';
      const info = document.createElement('div'); info.style.display='flex'; info.style.flexDirection='column'; info.style.gap='4px'; info.style.minWidth='0';
      info.innerHTML = `<div style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${o.title||o.name}</div>
                        <div class="muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${o.description||''}</div>`;
      left.appendChild(img); left.appendChild(info);
      const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end'; right.style.gap='8px';
      const priceEl = document.createElement('div'); priceEl.className='price'; priceEl.textContent = (o.price!=null)?`${Number(o.price)} kr`:'';
      const addBtn = document.createElement('button'); addBtn.className='buy-btn'; addBtn.textContent='Tilf√∏j';
      addBtn.onclick = ()=> addToCart({ id:`offer-${o.id}`, name:o.title||o.name||`Tilbud ${o.id}`, price:Number(o.price)||0, image_url:o.image_url||null });
      right.appendChild(priceEl); right.appendChild(addBtn);
      card.appendChild(left); card.appendChild(right);
      return card;
    }

    function placeholderImg(){
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="800" height="500">
          <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#e5e7eb"/><stop offset="1" stop-color="#cbd5e1"/></linearGradient>
          </defs>
          <rect width="100%" height="100%" fill="url(#g)"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Inter,Arial" font-size="28" fill="#94a3b8">Billede</text>
        </svg>`);
    }

    /* ================== SECTIONS ================== */
    async function showSection(section){
      pageContent.innerHTML='';
      document.querySelectorAll('.bottom-nav button').forEach(b=>b.classList.remove('active'));
      const ab = document.querySelector(`.bottom-nav button[data-section="${section}"]`); if(ab) ab.classList.add('active');

      if(section==='store'){
        pageTitle.textContent='Butik';
        const header = document.createElement('div');
        header.className='section-row';
        header.innerHTML = '<h3>Butik</h3>';
        pageContent.appendChild(header);

        const searchWrap=document.createElement('div');
        searchWrap.className='search-box';
        searchWrap.innerHTML = "<input id='productSearch' placeholder='S√∏g efter produkter‚Ä¶' />";
        pageContent.appendChild(searchWrap);

        const spinner = document.createElement('div');
        spinner.className='muted'; spinner.textContent='Henter produkter‚Ä¶';
        pageContent.appendChild(spinner);

        const { data: products } = await fetchProducts();
        pageContent.removeChild(spinner);

        if(!products || products.length===0){
          const empty = document.createElement('div');
          empty.className='muted'; empty.style.textAlign='center'; empty.style.padding='12px';
          empty.textContent='Ingen produkter fundet.';
          pageContent.appendChild(empty);
          return;
        }

        await Promise.all(products.map(async p=>{
          if(p.image_url && !p.image_url.startsWith('http')) p.image_url = await resolveImageUrl(p.image_url);
          p.price = Number(p.price)||0;
          p.id = (p.id!=null) ? p.id : Math.random().toString(36).slice(2,9);
          p.name = p.name || `Produkt ${p.id}`;
        }));

        const grid = document.createElement('div'); grid.className='product-grid';
        products.forEach(p=> grid.appendChild(createProductCard(p)));
        pageContent.appendChild(grid);

        // Search filter
        document.getElementById('productSearch').addEventListener('input', (e)=>{
          const q = e.target.value.toLowerCase().trim();
          const filtered = products.filter(p => (p.name||'').toLowerCase().includes(q));
          const newGrid=document.createElement('div'); newGrid.className='product-grid';
          filtered.forEach(p=> newGrid.appendChild(createProductCard(p)));
          grid.replaceWith(newGrid); // swap grid
          grid = newGrid;
        });
      }

      else if(section==='news'){
        pageTitle.textContent='Nyheder';
        const header = document.createElement('div'); header.className='section-row'; header.innerHTML='<h3>Nyheder</h3>';
        pageContent.appendChild(header);

        // Example news
        const newsContainer = document.createElement('div');
        newsContainer.style.display='grid'; newsContainer.style.gap='10px';
        [{title:'√Öbningstider i dag',text:'Vi har √•bent kl. 07‚Äì20'},
         {title:'Nye produkter',text:'Se vores nye sandwich i butikken'}]
        .forEach(n=>{
          const card = document.createElement('div'); card.className='offer-card'; card.style.alignItems='flex-start';
          card.innerHTML = `<div style="font-weight:800">${n.title}</div><div class="muted">${n.text}</div>`;
          newsContainer.appendChild(card);
        });
        pageContent.appendChild(newsContainer);

        const offersHeader=document.createElement('div'); offersHeader.className='section-row'; offersHeader.innerHTML='<h3>Tilbud</h3>';
        pageContent.appendChild(offersHeader);

        const offers = await fetchOffers();
        const offersWrap = document.createElement('div'); offersWrap.style.display='grid'; offersWrap.style.gap='8px';
        if(!offers || offers.length===0){
          const noOffers=document.createElement('div'); noOffers.className='offer-card'; noOffers.innerHTML='<div class="muted">Ingen tilbud fundet.</div>';
          offersWrap.appendChild(noOffers);
        } else {
          await Promise.all(offers.map(async o=>{ if(o.image_url && !o.image_url.startsWith('http')) o.image_url = await resolveImageUrl(o.image_url); }));
          offers.forEach(o=> offersWrap.appendChild(createOfferCard(o)));
        }
        pageContent.appendChild(offersWrap);
      }

      else if(section==='profile'){
        pageTitle.textContent='Profil';
        const header = document.createElement('div'); header.className='section-row'; header.innerHTML='<h3>Profil & Indstillinger</h3>';
        pageContent.appendChild(header);

        const { data: userResp } = await supabase.auth.getUser();
        const email = userResp?.user?.email || '';

        // Profile form
        const profile = getProfile();
        const formCard = document.createElement('div'); formCard.className='offer-card'; formCard.style.alignItems='stretch';
        formCard.innerHTML = `
          <div style="display:grid; gap:10px;">
            <div><strong>Email:</strong> ${email || '<span class="muted">Ikke angivet</span>'}</div>
            <label style="display:grid; gap:6px;">
              <span>Navn</span>
              <input id="profileName" placeholder="Fx. Anna Hansen" value="${profile.name||''}">
            </label>
            <label style="display:grid; gap:6px;">
              <span>Telefon</span>
              <input id="profilePhone" placeholder="+45 12 34 56 78" value="${profile.phone||''}">
            </label>
            <div style="display:flex; gap:8px; justify-content:flex-end;">
              <button class="btn ghost" id="btnResetProfile">Nulstil</button>
              <button class="btn primary" id="btnSaveProfile">Gem profil</button>
            </div>
          </div>
        `;
        pageContent.appendChild(formCard);

        // Orders
        const ordersHeader=document.createElement('div'); ordersHeader.className='section-row'; ordersHeader.innerHTML='<h3>Dine ordrer</h3>';
        pageContent.appendChild(ordersHeader);

        const ordersWrap=document.createElement('div'); ordersWrap.style.display='grid'; ordersWrap.style.gap='8px';
        const orders=getOrders();
        if(!orders.length){
          const empty=document.createElement('div'); empty.className='offer-card'; empty.innerHTML='<div class="muted">Ingen ordrer endnu. K√∏b noget i butikken for at se din ordrehistorik her.</div>';
          ordersWrap.appendChild(empty);
        } else {
          orders.forEach(o=>{
            const d=new Date(o.createdAt);
            const card=document.createElement('div'); card.className='offer-card'; card.style.alignItems='stretch';
            const itemsPreview=o.items.map(i=>`${i.qty}√ó ${i.name}`).slice(0,3).join(', ') + (o.items.length>3?' ‚Ä¶':'');
            card.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                <div>
                  <div style="font-weight:800">Ordre ${o.id}</div>
                  <div class="muted">${d.toLocaleDateString('da-DK', {year:'numeric',month:'short',day:'numeric', hour:'2-digit', minute:'2-digit'})}</div>
                  <div class="muted" style="margin-top:4px">${itemsPreview}</div>
                </div>
                <div style="text-align:right">
                  <div style="font-weight:800">${o.total} kr</div>
                  <button class="btn ghost" onclick='showOrder("${o.id}")'>Detaljer</button>
                </div>
              </div>`;
            ordersWrap.appendChild(card);
          });
        }
        pageContent.appendChild(ordersWrap);

        // Logout
        const logoutBlock=document.createElement('div'); logoutBlock.style.marginTop='10px';
        logoutBlock.innerHTML = '<button class="btn danger" onclick="logoutUser()">Log ud</button>';
        pageContent.appendChild(logoutBlock);

        // Wire profile actions
        document.getElementById('btnSaveProfile').addEventListener('click', ()=>{
          const name = (document.getElementById('profileName').value||'').trim();
          const phone= (document.getElementById('profilePhone').value||'').trim();
          saveProfile({name,phone});
          toast('‚úÖ Profil gemt', true);
        });
        document.getElementById('btnResetProfile').addEventListener('click', ()=>{
          document.getElementById('profileName').value='';
          document.getElementById('profilePhone').value='';
          saveProfile({});
          toast('Profil nulstillet', true);
        });
      }
    }
    window.showSection = showSection;

    /* Profile storage */
    function getProfile(){ try{return JSON.parse(localStorage.getItem(LS.PROFILE)||'{}')}catch(_){return{}} }
    function saveProfile(p){ localStorage.setItem(LS.PROFILE, JSON.stringify(p)); }

    /* Order details dialog */
    window.showOrder = (orderId)=>{
      const o = getOrders().find(x=>x.id===orderId);
      if(!o) return;
      const list = o.items.map(i=>`‚Ä¢ ${i.qty}√ó ${i.name} ‚Äî ${i.price} kr`).join('\n');
      openDialog({
        title:`Ordre ${o.id}`,
        body:`${new Date(o.createdAt).toLocaleString('da-DK')}\n${list}\nTotal: ${o.total} kr`,
        confirmText:'Luk',
        cancelText:''
      }).then(()=>{});
      dialogCancel.style.display='none';
      setTimeout(()=>dialogCancel.style.display='', 350);
    };

    async function logoutUser(){
      const ok = await openDialog({title:'Log ud', body:'Er du sikker p√• at du vil logge ud?', confirmText:'Log ud'});
      if(!ok) return;
      await supabase.auth.signOut();
      window.location.href = LOGIN_PAGE_URL;
    }
    window.logoutUser = logoutUser;

    /* ================== INIT ================== */
    function init(){
      renderCartCount();
      showSection('store');
    }
  </script>
</body>
</html>
