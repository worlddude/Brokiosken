<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brokiosken App</title>

  <style>
    /* --- Global Styles --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(145deg, #dbeafe, #f1f5f9);
      transition: background 0.4s ease;
    }

    body.dark {
      background: linear-gradient(160deg, #0f172a, #1e293b);
      color: #e2e8f0;
    }

    /* --- App Shell --- */
    .app-wrap {
      width: 92%;
      max-width: 420px;
      height: 95vh;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 24px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(20px);
      transition: background 0.3s, color 0.3s;
    }
    body.dark .app-wrap {
      background: rgba(30, 41, 59, 0.9);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    }

    /* --- Login Page --- */
    .container {
      padding: 40px 28px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      height: 100%;
      background: linear-gradient(160deg, #eff6ff 0%, #f9fafb 100%);
    }
    body.dark .container {
      background: linear-gradient(160deg, #1e293b, #0f172a);
    }

    h1 {
      font-size: 34px;
      font-weight: 800;
      color: #1d4ed8;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }
    body.dark h1 { color: #60a5fa; }

    h1 img {
      width: 38px;
      height: 38px;
      border-radius: 8px;
    }

    input {
      width: 100%;
      max-width: 320px;
      padding: 14px;
      border: 1px solid #d1d5db;
      border-radius: 14px;
      font-size: 16px;
      margin-bottom: 12px;
      background: #f9fafb;
      text-align: center;
      transition: all 0.2s ease;
    }
    input:focus {
      border-color: #2563eb;
      outline: none;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25);
    }
    body.dark input {
      background: #1e293b;
      border-color: #334155;
      color: #f1f5f9;
    }

    button {
      width: 100%;
      max-width: 320px;
      padding: 13px;
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      margin-bottom: 10px;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    p#status {
      margin-top: 12px;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.3s;
    }

    /* --- Header --- */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      color: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    /* --- Content Area --- */
    .content {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: #f8fafc;
      animation: fadeIn 0.3s ease;
    }
    body.dark .content {
      background: #1e293b;
      color: #e2e8f0;
    }

    /* --- Product Grid --- */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 14px;
    }

    .product-card, .offer-card {
      background: #ffffff;
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.15s, box-shadow 0.2s;
    }
    body.dark .product-card, body.dark .offer-card {
      background: #334155;
      color: #f8fafc;
    }
    .product-card:hover, .offer-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    .product-card img, .offer-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 10px;
    }

    .product-info { text-align: center; flex: 1; }

    .price { font-weight: 700; color: #111827; font-size: 15px; }
    body.dark .price { color: #f1f5f9; }

    .buy-btn {
      margin-top: 8px;
      width: 100%;
      background: linear-gradient(90deg, #06b6d4, #0ea5e9);
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      padding: 8px 12px;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .buy-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(6, 182, 212, 0.3);
    }

    /* --- Bottom Navigation --- */
    .bottom-nav {
      display: flex;
      justify-content: space-around;
      background: #e0e7ff;
      padding: 10px 0;
      border-top: 1px solid #cbd5e1;
    }
    body.dark .bottom-nav {
      background: #1e293b;
      border-color: #334155;
    }

    .bottom-nav button {
      background: none;
      border: none;
      color: #475569;
      font-weight: 500;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: color 0.25s, transform 0.15s;
    }
    body.dark .bottom-nav button { color: #cbd5e1; }

    .bottom-nav button img {
      width: 26px;
      height: 26px;
      opacity: 0.8;
    }
    .bottom-nav button.active {
      color: #2563eb;
      transform: scale(1.1);
    }
    .bottom-nav button.active img {
      opacity: 1;
      filter: drop-shadow(0 0 5px #93c5fd);
    }

    /* --- Cart Drawer --- */
    .cart-drawer {
      position: fixed;
      right: 12px;
      bottom: 72px;
      width: 320px;
      max-width: calc(100% - 40px);
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      display: none;
      flex-direction: column;
      z-index: 60;
      animation: slideUp 0.25s ease-out;
    }
    body.dark .cart-drawer { background: #334155; color: #f1f5f9; }

    .cart-header {
      padding: 14px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    body.dark .cart-header { background: #1e293b; border-color: #475569; }

    .cart-list {
      max-height: 320px;
      overflow: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .cart-row img {
      width: 44px;
      height: 44px;
      object-fit: cover;
      border-radius: 8px;
    }

    .cart-actions {
      padding: 12px 16px;
      background: #f9fafb;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    body.dark .cart-actions { background: #1e293b; border-color: #475569; }

    .checkout-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(90deg, #10b981, #22c55e);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .checkout-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
    }

    /* --- Section Header --- */
    .section-row h3 {
      margin: 0;
      font-size: 16px;
      color: #1d4ed8;
      font-weight: 700;
    }
    body.dark .section-row h3 { color: #93c5fd; }

    /* --- Animations --- */
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    @media (max-width: 420px) {
      .cart-drawer { right: 8px; left: 8px; width: auto; }
    }
  </style>
</head>
<body>

  <div class="app-wrap" id="app">
    <!-- LOGIN -->
    <div class="container" id="loginPage">
      <h1><img src="./icons/logo.png" alt="logo" /> Brokiosken</h1>
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Adgangskode" />
      <button onclick="signupUser()">Opret bruger</button>
      <button onclick="loginUser()">Log ind</button>
      <p id="status"></p>
    </div>

    <!-- MAIN APP -->
    <div id="mainPage" style="display:none; height:100%; flex-direction:column;">
      <div class="header">
        <h2 id="pageTitle">Butik</h2>
        <div class="right">
          <button class="cart-btn" id="cartToggle" title="Vis kurv" onclick="toggleCart()">
            <img src="./icons/cart.png" alt="Kurv" style="width:24px;height:24px;filter:invert(100%)" />
            <span class="cart-count" id="cartCount" style="display:none">0</span>
          </button>
        </div>
      </div>

      <div class="content" id="pageContent"></div>

      <div class="bottom-nav">
        <button data-section="news" onclick="showSection('news')">
          <img src="./icons/discount.png" alt="Tilbud" />
          <span>Nyheder</span>
        </button>
        <button data-section="store" onclick="showSection('store')" class="active">
          <img src="./icons/shop.png" alt="Butik" />
          <span>Butik</span>
        </button>
        <button data-section="profile" onclick="showSection('profile')">
          <img src="./icons/user.png" alt="Profil" />
          <span>Profil</span>
        </button>
      </div>

      <!-- CART DRAWER -->
      <div class="cart-drawer" id="cartDrawer">
        <div class="cart-header">
          <strong>Din kurv</strong>
          <button onclick="closeCart()" style="border:none;background:none;cursor:pointer;font-weight:700;color:inherit;">âœ•</button>
        </div>
        <div class="cart-list" id="cartList"></div>
        <div class="cart-actions">
          <div><strong>Total:</strong> <span id="cartTotal">0 kr</span></div>
          <div><button class="checkout-btn" onclick="checkout()">KÃ¸b</button></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT (original logic, dark mode addition only) -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const supabase = createClient(
      'https://olfvimlmyqtadzkwiibg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sZnZpbWxteXF0YWR6a3dpaWJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNDgyNTcsImV4cCI6MjA3NzcyNDI1N30.KgNwLHO7fDH1YCRb5cEc9Yo-mSNtae83B783o-0Hqr4'
    );

    const status=document.getElementById('status');
    const loginPage=document.getElementById('loginPage');
    const mainPage=document.getElementById('mainPage');
    const pageContent=document.getElementById('pageContent');
    const pageTitle=document.getElementById('pageTitle');
    const cartCountEl=document.getElementById('cartCount');
    const cartDrawer=document.getElementById('cartDrawer');

    function showMessage(text,success=true){
      status.textContent=text;
      status.style.color=success?'#1d4ed8':'#dc2626';
      status.style.opacity='1';
      setTimeout(()=>status.style.opacity='0',4000);
    }

    async function signupUser(){
      const email=document.getElementById('email').value.trim();
      const password=document.getElementById('password').value.trim();
      if(!email||!password)return showMessage('Udfyld email og adgangskode.',false);
      const{error}=await supabase.auth.signUp({email,password});
      if(error)showMessage(`Fejl: ${error.message}`,false);
      else showMessage('âœ… Bruger oprettet! Tjek din email for bekrÃ¦ftelse.',true);
    }

    async function loginUser(){
      const email=document.getElementById('email').value.trim();
      const password=document.getElementById('password').value.trim();
      if(!email||!password)return showMessage('Udfyld email og adgangskode.',false);
      const{data,error}=await supabase.auth.signInWithPassword({email,password});
      if(error){showMessage(`Fejl: ${error.message}`,false);}
      else{
        showMessage('âœ… Du er nu logget ind!',true);
        setTimeout(()=>{loginPage.style.display='none';mainPage.style.display='flex';showSection('store');},600);
      }
    }

    async function logoutUser(){
      await supabase.auth.signOut();
      mainPage.style.display='none';
      loginPage.style.display='flex';
      showMessage('Du er logget ud.',true);
    }

    function getCart(){try{return JSON.parse(localStorage.getItem('brokiosken_cart')||'[]')}catch(e){return[]}}
    function saveCart(cart){localStorage.setItem('brokiosken_cart',JSON.stringify(cart));renderCartCount();}
    function addToCart(product){const cart=getCart();const found=cart.find(i=>i.id===product.id);if(found)found.qty=(found.qty||1)+1;else cart.push(Object.assign({},product,{qty:1}));saveCart(cart);showMessage('âœ… TilfÃ¸jet til kurven',true);}
    function removeFromCart(productId){let cart=getCart().filter(i=>i.id!==productId);saveCart(cart);renderCart();}
    function renderCartCount(){const cart=getCart();const totalQty=cart.reduce((s,i)=>s+(i.qty||0),0);if(totalQty>0){cartCountEl.style.display='inline-block';cartCountEl.textContent=totalQty;}else{cartCountEl.style.display='none';}}
    function toggleCart(){if(cartDrawer.style.display==='flex')closeCart();else openCart();}
    function openCart(){renderCart();cartDrawer.style.display='flex';}
    function closeCart(){cartDrawer.style.display='none';}
    function renderCart(){const cartList=document.getElementById('cartList');const cart=getCart();cartList.innerHTML='';let total=0;cart.forEach(item=>{total+=(item.price||0)*(item.qty||1);const row=document.createElement('div');row.className='cart-row';row.innerHTML=`<img src="${item.image_url||'./icons/placeholder.png'}" alt="${item.name}" /><div style="flex:1;min-width:0"><div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${item.name}</div><div style="font-size:13px">${item.qty} Ã— ${item.price} kr</div></div><div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end"><button style="border:none;background:none;cursor:pointer;color:#ef4444;font-weight:700" onclick="removeFromCart('${item.id}')">Fjern</button></div>`;cartList.appendChild(row);});document.getElementById('cartTotal').textContent=`${total} kr`;renderCartCount();}
    function checkout(){const cart=getCart();if(!cart.length)return showMessage('Din kurv er tom',false);localStorage.removeItem('brokiosken_cart');renderCartCount();renderCart();showMessage('Tak! Din ordre er modtaget (demo).',true);closeCart();}
    async function resolveImageUrl(imageField){if(!imageField)return'./icons/placeholder.png';if(imageField.startsWith('http'))return imageField;try{const{data}=supabase.storage.from('product-images').getPublicUrl(imageField);if(data&&data.publicUrl)return data.publicUrl;}catch(e){console.warn('resolveImageUrl error',e);}return imageField;}
    async function fetchProducts(){const{data,error}=await supabase.from('products').select('id,name,price,image_url');if(error){console.error('Products fetch error',error);return{error,data:[]}}return{data:data||[],error:null}}
    async function fetchOffers(){const{data,error}=await supabase.from('offers').select('id,title,description,price,image_url');if(error||!data){return[{id:1,title:'ðŸŽ‰ 2x Kaffe To Go - kun 40 kr!',description:'',price:40},{id:2,title:'ðŸ¥ª Ny sandwich: Kylling & Bacon',description:'',price:45}]}return data;}

    function createProductCard(p){const card=document.createElement('div');card.className='product-card';const img=document.createElement('img');img.src=p.image_url||'./icons/placeholder.png';img.alt=p.name;const info=document.createElement('div');info.className='product-info';info.innerHTML=`<div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name}</div><div style="color:#64748b;font-size:13px">Produkt-id: ${p.id}</div>`;const actions=document.createElement('div');actions.className='product-actions';const priceEl=document.createElement('div');priceEl.className='price';priceEl.textContent=`${p.price} kr`;const buyBtn=document.createElement('button');buyBtn.className='buy-btn';buyBtn.textContent='TilfÃ¸j';buyBtn.onclick=()=>addToCart({id:String(p.id),name:p.name,price:Number(p.price)||0,image_url:p.image_url});actions.appendChild(priceEl);actions.appendChild(buyBtn);card.appendChild(img);card.appendChild(info);card.appendChild(actions);return card;}

    function createOfferCard(o){const card=document.createElement('div');card.className='offer-card';const left=document.createElement('div');left.style.display='flex';left.style.gap='10px';left.style.alignItems='center';left.style.flex='1';left.style.minWidth='0';const img=document.createElement('img');img.src=o.image_url||'./icons/placeholder.png';img.alt=o.title;img.style.width='64px';img.style.height='64px';img.style.objectFit='cover';img.style.borderRadius='8px';const info=document.createElement('div');info.style.display='flex';info.style.flexDirection='column';info.style.gap='4px';info.style.minWidth='0';info.innerHTML=`<div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${o.title||o.name}</div><div style="color:#475569;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${o.description||''}</div>`;left.appendChild(img);left.appendChild(info);const right=document.createElement('div');right.style.display='flex';right.style.flexDirection='column';right.style.alignItems='flex-end';right.style.gap='8px';const priceEl=document.createElement('div');priceEl.className='price';priceEl.textContent=(o.price!==undefined&&o.price!==null)?`${Number(o.price)} kr`:'';const addBtn=document.createElement('button');addBtn.className='buy-btn';addBtn.textContent='TilfÃ¸j';addBtn.onclick=()=>addToCart({id:`offer-${o.id}`,name:o.title||o.name||`Tilbud ${o.id}`,price:Number(o.price)||0,image_url:o.image_url||null});right.appendChild(priceEl);right.appendChild(addBtn);card.appendChild(left);card.appendChild(right);return card;}

    async function showSection(section){
      pageContent.innerHTML='';
      document.querySelectorAll('.bottom-nav button').forEach(btn=>btn.classList.remove('active'));
      const activeBtn=document.querySelector(`.bottom-nav button[data-section="${section}"]`);
      if(activeBtn)activeBtn.classList.add('active');

      if(section==='store'){
        pageTitle.textContent='Butik';
        const searchWrap=document.createElement('div');
        searchWrap.className='search-box';
        searchWrap.innerHTML="<input type='text' id='productSearch' placeholder='SÃ¸g efter produkter...' />";
        pageContent.appendChild(searchWrap);
        const spinner=document.createElement('div');spinner.textContent='Henter produkterâ€¦';pageContent.appendChild(spinner);
        const{data:products}=await fetchProducts();
        pageContent.removeChild(spinner);
        if(!products||products.length===0){pageContent.innerHTML='<div style="padding:12px;text-align:center;color:#475569">Ingen produkter fundet.</div>';return;}
        await Promise.all(products.map(async p=>{if(p.image_url&&!p.image_url.startsWith('http'))p.image_url=await resolveImageUrl(p.image_url);p.price=Number(p.price)||0;p.id=p.id!==undefined?p.id:Math.random().toString(36).slice(2,9);p.name=p.name||`Produkt ${p.id}`;}));
        const grid=document.createElement('div');grid.className='product-grid';products.forEach(p=>grid.appendChild(createProductCard(p)));pageContent.appendChild(grid);
        document.getElementById('productSearch').addEventListener('input',e=>{
          const q=e.target.value.toLowerCase().trim();
          const filtered=products.filter(p=>(p.name||'').toLowerCase().includes(q));
          const newGrid=document.createElement('div');newGrid.className='product-grid';
          filtered.forEach(p=>newGrid.appendChild(createProductCard(p)));
          const oldGrid=pageContent.querySelector('.product-grid');
          if(oldGrid)oldGrid.replaceWith(newGrid);
        });
      }

      else if(section==='news'){
        pageTitle.textContent='Nyheder';
        const newsHeader=document.createElement('div');
        newsHeader.className='section-row';
        newsHeader.innerHTML='<h3>Nyheder</h3>';
        pageContent.appendChild(newsHeader);

        const newsContainer=document.createElement('div');
        newsContainer.style.display='flex';
        newsContainer.style.flexDirection='column';
        newsContainer.style.gap='10px';
        const exampleNews=[{id:'n1',title:'Ã…bningstider i dag',text:'Vi har Ã¥bent kl. 07-20'},{id:'n2',title:'Nye produkter',text:'Se vores nye sandwich i butikken'}];
        exampleNews.forEach(n=>{
          const card=document.createElement('div');
          card.className='offer-card';
          card.style.alignItems='flex-start';
          card.innerHTML=`<div style="font-weight:700">${n.title}</div><div style="color:#475569;font-size:13px">${n.text}</div>`;
          newsContainer.appendChild(card);
        });
        pageContent.appendChild(newsContainer);

        const offersHeader=document.createElement('div');
        offersHeader.className='section-row';
        offersHeader.innerHTML='<h3>Tilbud</h3>';
        pageContent.appendChild(offersHeader);

        const offers=await fetchOffers();
        const offersWrap=document.createElement('div');
        offersWrap.style.display='flex';
        offersWrap.style.flexDirection='column';
        offersWrap.style.gap='8px';
        if(!offers||offers.length===0){
          const noOffers=document.createElement('div');
          noOffers.style.padding='8px';noOffers.style.color='#475569';
          noOffers.textContent='Ingen tilbud fundet.';
          offersWrap.appendChild(noOffers);
        } else {
          await Promise.all(offers.map(async o=>{if(o.image_url&&!o.image_url.startsWith('http'))o.image_url=await resolveImageUrl(o.image_url);}));
          offers.forEach(o=>offersWrap.appendChild(createOfferCard(o)));
        }
        pageContent.appendChild(offersWrap);
      }

      else if(section==='profile'){
        pageTitle.textContent='Profil';
        const userResp=await supabase.auth.getUser();
        const user=userResp&&userResp.data?userResp.data.user:null;
        const email=(user&&user.email)||document.getElementById('email').value||'';
        const profileWrap=document.createElement('div');
        profileWrap.innerHTML=`
          <div style="padding:12px">
            <h3 style="color:#4a609e;">Din profil</h3>
            <p><strong>Email:</strong> ${email}</p>
            <p><strong>Loyalitetspoint:</strong> 120 point</p>
            <div style="margin-top:10px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                <input type="checkbox" id="darkToggle"> ðŸŒ™ MÃ¸rk tilstand
              </label>
            </div>
            <button class="logout-btn" style="margin-top:14px;background:#ef4444" onclick="logoutUser()">Log ud</button>
          </div>
        `;
        pageContent.appendChild(profileWrap);
        const toggle=document.getElementById('darkToggle');
        toggle.checked=document.body.classList.contains('dark');
        toggle.addEventListener('change',()=>document.body.classList.toggle('dark'));
      }
    }

    window.signupUser=signupUser;
    window.loginUser=loginUser;
    window.logoutUser=logoutUser;
    window.showSection=showSection;
    window.addToCart=addToCart;
    window.toggleCart=toggleCart;
    window.openCart=openCart;
    window.closeCart=closeCart;
    window.removeFromCart=removeFromCart;
    window.checkout=checkout;
    (function init(){renderCartCount()})();
  </script>
</body>
</html>
