<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Brokiosken ‚Äì App</title>

  <!-- Inter font for consistent look with login page -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ---------------- Theme ---------------- */
    :root{
      --bg-grad: radial-gradient(circle at top, #e0ecff 0, #f4f6fb 45%, #edf2f7 100%);
      --card: rgba(255,255,255,0.9);
      --text: #0f172a;
      --muted:#64748b;
      --brand1:#2563eb;
      --brand2:#3b82f6;
      --accent1:#06b6d4;
      --accent2:#0ea5e9;
      --success1:#10b981; --success2:#22c55e;
      --danger:#ef4444;
      --border: rgba(15,23,42,.08);
      --ring: rgba(59,130,246,.25);
      --shadow: 0 18px 45px rgba(15,23,42,.18);
      --radius:24px;
    }

    @media (prefers-color-scheme: dark) {
      :root{
        --bg-grad: radial-gradient(circle at top, #1e293b 0, #020617 55%);
        --card: rgba(15,23,42,0.96);
        --text:#e5e7eb;
        --muted:#94a3b8;
        --brand1:#1d4ed8; --brand2:#3b82f6;
        --accent1:#0ea5e9; --accent2:#38bdf8;
        --success1:#10b981; --success2:#34d399;
        --danger:#f87171;
        --border: rgba(148,163,184,.35);
        --ring: rgba(96,165,250,.45);
        --shadow: 0 20px 60px rgba(0,0,0,.75);
      }
    }

    /* ---------------- Base ---------------- */
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background: var(--bg-grad);
      color: var(--text);
      display:flex;
      justify-content:center;
      align-items:stretch;
      padding:24px 16px;
    }

    .muted{
      color:var(--muted);
      font-size:13px;
    }

    /* ---------------- App shell ---------------- */
    .app-wrap{
      width:100%;
      max-width:1120px;
      max-height:880px;
      background: var(--card);
      backdrop-filter: blur(26px);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      animation: fadeIn .45s ease;
    }

    @media (max-width:768px){
      .app-wrap{
        max-height:none;
        height:100%;
      }
      body{
        padding:0;
      }
    }

    /* Header / top bar */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 22px;
      border-bottom:1px solid var(--border);
      background:
        radial-gradient(circle at top left, rgba(59,130,246,.32) 0, transparent 50%),
        radial-gradient(circle at top right, rgba(56,189,248,.26) 0, transparent 55%),
        linear-gradient(90deg, rgba(15,23,42,.9), rgba(15,23,42,.94));
      color:#f9fafb;
      position:relative;
      z-index:2;
    }
    .htitle{ display:flex; align-items:center; gap:12px; }
    .mark{
      width:34px; height:34px; border-radius:14px;
      display:grid; place-items:center; font-weight:900; font-size:15px;
      background: linear-gradient(135deg, rgba(59,130,246,.9), rgba(56,189,248,.9));
      box-shadow:0 10px 25px rgba(37,99,235,.55);
    }
    .header h2{ margin:0; font-size:20px; font-weight:800; letter-spacing:.02em; }
    .header-sub{
      font-size:13px;
      opacity:.8;
    }

    .header-right{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .pill{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.5);
      border:1px solid rgba(148,163,184,.5);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .pill-dot{
      width:8px;height:8px;border-radius:999px;
      background:linear-gradient(135deg,var(--success1),var(--success2));
      box-shadow:0 0 0 4px rgba(34,197,94,.25);
    }

    .iconbtn{
      background:none; border:none; color:inherit; cursor:pointer; position:relative; padding:6px;
      border-radius:999px;
      display:grid; place-items:center;
      transition:background .15s, transform .1s;
    }
    .iconbtn:hover{
      background:rgba(15,23,42,.35);
      transform:translateY(-1px);
    }
    .badge{
      position:absolute; top:-4px; right:-4px; background:#ef4444; color:#fff; font-size:11px; padding:2px 6px; border-radius:999px; display:none;
      box-shadow:0 0 0 2px rgba(15,23,42,1);
    }

    /* Secondary nav (tabs) */
    .top-nav{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 22px;
      border-bottom:1px solid rgba(148,163,184,.35);
      background:linear-gradient(180deg, rgba(15,23,42,.02), transparent);
    }
    .top-nav-title{
      font-size:14px;
      font-weight:600;
      color:var(--muted);
      margin-right:10px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .top-nav-title span{
      width:6px;height:6px;border-radius:999px;
      background:linear-gradient(135deg,var(--brand1),var(--brand2));
    }
    .bottom-nav{
      display:flex; 
      gap:6px;
      padding:0;
      border-top:none;
      background:transparent;
    }
    .bottom-nav button{
      background:none; border:none; color:var(--muted); font-weight:600; font-size:13px; cursor:pointer;
      display:flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px;
      transition: transform .12s, background .2s, color .2s, box-shadow .15s;
    }
    .bottom-nav button .nav-ico{
      width:20px;height:20px;display:grid;place-items:center;font-size:15px;
    }
    .bottom-nav button.active{
      color:#0b1120;
      background: linear-gradient(90deg,rgba(239,246,255,1),rgba(219,234,254,1));
      box-shadow: 0 10px 20px rgba(148,163,184,.4);
      transform: translateY(-1px);
    }

    @media (max-width:640px){
      .top-nav{
        padding:10px 14px 6px;
        flex-wrap:wrap;
      }
      .bottom-nav{
        justify-content:space-between;
        width:100%;
      }
      .bottom-nav button{
        flex:1;
        justify-content:center;
        font-size:12px;
        padding-inline:6px;
      }
      .bottom-nav button span{
        display:none;
      }
    }

    /* Content */
    .content{
      flex:1;
      overflow-y:auto;
      padding:16px 22px 18px;
      background: radial-gradient(circle at top left, rgba(191,219,254,.45) 0, transparent 55%), transparent;
    }

    @media (max-width:640px){
      .content{
        padding:14px;
      }
    }

    .section-row{
      display:flex; align-items:center; justify-content:space-between; margin: 4px 2px 12px;
    }
    .section-row h3{
      margin:0; font-size:18px; font-weight:800;
      background:linear-gradient(120deg,var(--brand1),var(--brand2));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      letter-spacing:.02em;
    }
    .section-caption{
      font-size:13px;
      color:var(--muted);
    }

    /* Search */
    .search-box{
      width:100%; display:flex; justify-content:flex-start; margin-bottom:14px;
    }
    .search-box input{
      width:320px; max-width:100%; padding:10px 14px; border-radius:999px; border:1px solid var(--border);
      background: rgba(255,255,255,.9); color:var(--text); outline:none;
      transition: box-shadow .2s, border-color .2s, background .2s;
      font-size:14px;
    }
    .search-box input::placeholder{
      color:rgba(148,163,184,.9);
    }
    .search-box input:focus{
      box-shadow:0 0 0 3px var(--ring);
      border-color:transparent;
      background:#fff;
    }

    /* Grid & Cards */
    .product-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(190px,1fr));
      gap:14px;
    }

    .product-card,
    .offer-card{
      background: rgba(255,255,255,0.98);
      border:1px solid rgba(148,163,184,.3);
      border-radius:18px;
      box-shadow: 0 10px 20px rgba(15,23,42,.08);
      padding:12px;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      transition: transform .12s, box-shadow .2s, border-color .2s, background .2s;
    }

    @media (prefers-color-scheme: dark){
      .product-card,
      .offer-card{
        background: rgba(15,23,42,0.98);
        border-color:rgba(51,65,85,.9);
      }
    }

    .product-card:hover,
    .offer-card:hover{
      transform:translateY(-4px);
      box-shadow:0 18px 30px rgba(15,23,42,.18);
      border-color:rgba(59,130,246,.55);
    }

    .product-card img,
    .offer-card img{
      width:100%;
      height:150px;
      object-fit:cover;
      border-radius:14px;
      margin-bottom:10px;
      background:#e5e7eb;
    }
    .product-info{
      text-align:left; flex:1;
    }

    .product-title{
      font-weight:700;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .product-meta{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }

    .price{
      font-weight:800;
      font-size:15px;
      margin-top:6px;
    }

    .buy-btn{
      margin-top:10px; width:100%;
      border:none; border-radius:999px; color:#fff; font-weight:700; padding:9px 12px; cursor:pointer;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      transition: transform .12s, box-shadow .12s, filter .1s;
      font-size:14px;
    }
    .buy-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 22px rgba(6,182,212,.35);
      filter:brightness(1.02);
    }

    /* Offer layout */
    .offer-card-row{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .offer-img{
      width:70px;
      height:70px;
      border-radius:12px;
      object-fit:cover;
      flex-shrink:0;
    }
    .offer-content{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      flex:1;
    }
    .offer-title{
      font-weight:700;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .offer-desc{
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .offer-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
    }

    /* Cart drawer */
    .cart-drawer{
      position:fixed; right:24px; top:90px; width:340px; max-width:calc(100% - 48px);
      background: var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow);
      display:none; flex-direction:column; overflow:hidden; z-index:60; animation: fadeIn .25s ease;
    }
    .cart-header,
    .cart-actions{
      padding:10px 14px; display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(90deg,rgba(248,250,252,.88),rgba(241,245,249,.9));
      border-bottom:1px solid var(--border);
    }
    .cart-actions{
      border-top:1px solid var(--border);
      border-bottom:none;
      background:rgba(248,250,252,0.9);
    }
    .cart-title{
      font-weight:700;
      font-size:14px;
    }
    .cart-sub{
      font-size:12px;
      color:var(--muted);
    }
    .cart-list{
      padding:10px 12px; max-height:320px; overflow:auto; display:flex; flex-direction:column; gap:8px;
    }
    .cart-row{
      display:flex; gap:10px; align-items:center;
      padding:6px;
      border-radius:10px;
      background:rgba(248,250,252,.8);
    }
    .cart-row img{
      width:44px; height:44px; object-fit:cover; border-radius:10px;
    }
    .checkout-btn{
      padding:8px 12px; border:none; border-radius:999px; cursor:pointer; color:#fff; font-weight:800;
      background: linear-gradient(90deg,var(--success1),var(--success2));
      font-size:13px;
      box-shadow:0 10px 18px rgba(22,163,74,.4);
    }

    /* Dialog */
    .dialog-backdrop{
      position:fixed; inset:0; background: rgba(15,23,42,.5);
      display:none; place-items:center; z-index:80;
    }
    .dialog{
      width:min(92vw,380px); background: var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); padding:16px 18px;
      white-space:pre-line;
    }
    .dialog h4{ margin:0 0 6px; font-size:16px; }
    .dialog-body{
      font-size:13px;
      color:var(--muted);
      margin-top:2px;
    }
    .dialog .actions{
      display:flex; gap:8px; justify-content:flex-end; margin-top:14px;
    }
    .btn{
      padding:9px 12px; border:none; border-radius:999px; cursor:pointer; font-weight:700; font-size:13px; font-family:inherit;
    }
    .btn.primary{ background: linear-gradient(90deg,var(--brand1),var(--brand2)); color:#fff; }
    .btn.ghost{ background:none; border:1px solid var(--border); color:var(--text); }
    .btn.danger{ background: linear-gradient(90deg,var(--danger),#fb7185); color:#fff; }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
      background:rgba(15,23,42,.96); color:#fff; padding:9px 14px; border-radius:999px; font-size:13px;
      box-shadow:0 12px 30px rgba(15,23,42,.8);
      opacity:0; transition:opacity .25s, transform .25s; z-index:90;
      transform:translate(-50%, 8px);
    }

    /* Utility cards for profile */
    .profile-grid{
      display:grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap:14px;
    }
    @media (max-width:880px){
      .profile-grid{
        grid-template-columns: minmax(0,1fr);
      }
    }

    .offer-card input{
      border-radius:10px;
      border:1px solid var(--border);
      padding:8px 10px;
      font-family:inherit;
      font-size:14px;
      outline:none;
      width:100%;
      background:rgba(248,250,252,.9);
      color:var(--text);
    }
    .offer-card input:focus{
      box-shadow:0 0 0 3px var(--ring);
      border-color:transparent;
      background:#fff;
    }
    .field-label{
      font-size:12px;
      font-weight:600;
      color:var(--muted);
      letter-spacing:.03em;
      text-transform:uppercase;
    }

    /* Responsive cart */
    @media (max-width:640px){
      .cart-drawer{
        right:12px;
        left:12px;
        top:auto;
        bottom:76px;
        width:auto;
      }
    }

    @keyframes fadeIn{
      from{opacity:0; transform:translateY(6px);}
      to{opacity:1; transform:translateY(0);}
    }
  </style>
</head>
<body>
  <div class="app-wrap" id="app">
    <!-- Header -->
    <div class="header">
      <div class="htitle">
        <div class="mark">BK</div>
        <div>
          <h2 id="pageTitle">Butik</h2>
          <div class="header-sub">Bestil dine varer direkte fra Brokiosken</div>
        </div>
      </div>
      <div class="header-right">
        <div class="pill">
          <span class="pill-dot"></span>
          <span>√Öben til 20:00</span>
        </div>
        <button class="iconbtn" id="cartToggle" title="Vis kurv">
          <span class="badge" id="cartCount">0</span>
          <div class="nav-ico" aria-hidden="true">üõí</div>
        </button>
      </div>
    </div>

    <!-- Top Nav -->
    <div class="top-nav">
      <div class="top-nav-title">
        <span></span>
        <span></span>
      </div>
      <div class="bottom-nav">
        <button data-section="news" onclick="showSection('news')">
          <div class="nav-ico">üè∑Ô∏è</div>
          <span>Nyheder</span>
        </button>
        <button data-section="store" class="active" onclick="showSection('store')">
          <div class="nav-ico">üè™</div>
          <span>Butik</span>
        </button>
        <button data-section="profile" onclick="showSection('profile')">
          <div class="nav-ico">üë§</div>
          <span>Profil</span>
        </button>
      </div>
    </div>

    <!-- Content -->
    <div class="content" id="pageContent"></div>

    <!-- Cart Drawer -->
    <div class="cart-drawer" id="cartDrawer">
      <div class="cart-header">
        <div>
          <div class="cart-title">Din kurv</div>
          <div class="cart-sub">Se og ret dine varer inden betaling</div>
        </div>
        <button class="iconbtn" onclick="closeCart()">‚úï</button>
      </div>
      <div class="cart-list" id="cartList"></div>
      <div class="cart-actions">
        <div>
          <div class="cart-title">Total</div>
          <div id="cartTotal" class="price" style="font-size:14px;">0 kr</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn ghost" onclick="clearCart()">T√∏m</button>
          <button class="checkout-btn" onclick="checkout()">G√• til betaling</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dialog -->
  <div class="dialog-backdrop" id="dialogBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="dialog">
      <h4 id="dialogTitle">Bekr√¶ft</h4>
      <div id="dialogBody" class="dialog-body">Er du sikker?</div>
      <div class="actions">
        <button class="btn ghost" id="dialogCancel">Annuller</button>
        <button class="btn danger" id="dialogConfirm">Bekr√¶ft</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Supabase (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ================== CONFIG ================== */
    const LOGIN_PAGE_URL = "https://worlddude.github.io/Brokiosken/Login.html"; // üîÅ CHANGE THIS IF NEEDED
    const supabase = window.supabase.createClient(
      "https://olfvimlmyqtadzkwiibg.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sZnZpbWxteXF0YWR6a3dpaWJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNDgyNTcsImV4cCI6MjA3NzcyNDI1N30.KgNwLHO7fDH1YCRb5cEc9Yo-mSNtae83B783o-0Hqr4"
    );

    /* ================== ELEMENTS ================== */
    const pageContent = document.getElementById('pageContent');
    const pageTitle   = document.getElementById('pageTitle');
    const cartDrawer  = document.getElementById('cartDrawer');
    const cartList    = document.getElementById('cartList');
    const cartTotalEl = document.getElementById('cartTotal');
    const cartCountEl = document.getElementById('cartCount');
    const cartToggle  = document.getElementById('cartToggle');
    const dialogBackdrop = document.getElementById('dialogBackdrop');
    const dialogTitle = document.getElementById('dialogTitle');
    const dialogBody  = document.getElementById('dialogBody');
    const dialogCancel= document.getElementById('dialogCancel');
    const dialogConfirm= document.getElementById('dialogConfirm');
    const toastEl     = document.getElementById('toast');

    /* ================== HELPERS ================== */
    const LS = {
      CART: 'brokiosken_cart',
      PROFILE: 'brokiosken_profile',
      ORDERS: 'brokiosken_orders'
    };

    function toast(msg, ok=true){
      toastEl.textContent = msg;
      toastEl.style.background = ok ? 'rgba(16,185,129,.96)' : 'rgba(239,68,68,.96)';
      toastEl.style.opacity = '1';
      toastEl.style.transform = 'translate(-50%, 0)';
      setTimeout(()=>{
        toastEl.style.opacity='0';
        toastEl.style.transform = 'translate(-50%, 8px)';
      }, 2600);
    }

    function openDialog({title='Bekr√¶ft', body='Er du sikker?', confirmText='Bekr√¶ft', cancelText='Annuller'}){
      dialogTitle.textContent = title;
      dialogBody.textContent = body;
      dialogConfirm.textContent = confirmText;
      dialogCancel.textContent  = cancelText || 'Luk';
      dialogBackdrop.style.display = 'grid';
      dialogBackdrop.setAttribute('aria-hidden','false');
      return new Promise((resolve)=>{
        const onCancel = ()=>{ cleanup(); resolve(false); };
        const onConfirm= ()=>{ cleanup(); resolve(true); };
        function cleanup(){
          dialogBackdrop.style.display = 'none';
          dialogBackdrop.setAttribute('aria-hidden','true');
          dialogCancel.removeEventListener('click', onCancel);
          dialogConfirm.removeEventListener('click', onConfirm);
        }
        dialogCancel.addEventListener('click', onCancel, {once:true});
        dialogConfirm.addEventListener('click', onConfirm, {once:true});
      });
    }

    /* ================== AUTH GUARD ================== */
    (async function guard(){
      try{
        const { data: { user } } = await supabase.auth.getUser();
        if(!user){ window.location.href = LOGIN_PAGE_URL; return; }
        init(); // only init when logged in
      }catch(e){
        // if anything fails, fail-safe redirect
        window.location.href = LOGIN_PAGE_URL;
      }
    })();

    /* ================== DATA (Supabase) ================== */
    async function resolveImageUrl(imageField){
      if(!imageField) return placeholderImg();
      if(imageField.startsWith('http')) return imageField;
      try{
        const { data } = supabase.storage.from('product-images').getPublicUrl(imageField);
        if(data && data.publicUrl) return data.publicUrl;
      }catch(e){ console.warn('resolveImageUrl error', e); }
      return imageField;
    }

    async function fetchProducts(){
      const { data, error } = await supabase.from('products').select('id,name,price,image_url');
      if(error){
        console.error('Products fetch error', error);
        return { error, data: [] };
      }
      return { data: data||[], error: null };
    }

    async function fetchOffers(){
      const { data, error } = await supabase.from('offers').select('id,title,description,price,image_url');
      if(error || !data){
        return [
          {id:1,title:'üéâ 2x Kaffe To Go - kun 40 kr!',description:'G√¶lder alle hverdage f√∏r kl. 10',price:40},
          {id:2,title:'ü•™ Ny sandwich: Kylling & Bacon',description:'Sp√∏rg i kiosken for mere info',price:45}
        ];
      }
      return data;
    }

    /* ================== CART ================== */
    function getCart(){ try{return JSON.parse(localStorage.getItem(LS.CART)||'[]')}catch(_){return[]} }
    function saveCart(cart){ localStorage.setItem(LS.CART, JSON.stringify(cart)); renderCartCount(); }

    function addToCart(product){
      const cart = getCart();
      const found = cart.find(i=>i.id===product.id);
      if(found) found.qty = (found.qty||1)+1; else cart.push({...product, qty:1});
      saveCart(cart); toast('‚úÖ Tilf√∏jet til kurven', true);
    }

    function removeFromCart(id){
      const cart = getCart().filter(i=>i.id!==id);
      saveCart(cart); renderCart();
    }

    function clearCart(){ saveCart([]); renderCart(); toast('Kurven er tom.', true); }

    function renderCartCount(){
      const totalQty = getCart().reduce((s,i)=>s+(i.qty||0),0);
      if(totalQty>0){
        cartCountEl.style.display='inline-block';
        cartCountEl.textContent= totalQty;
      } else {
        cartCountEl.style.display='none';
      }
    }

    function renderCart(){
      const cart = getCart();
      cartList.innerHTML = '';
      let total = 0;
      cart.forEach(item=>{
        total += (item.price||0)*(item.qty||1);
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
          <img src="${item.image_url||placeholderImg()}" alt="${item.name}" />
          <div style="flex:1;min-width:0">
            <div style="font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${item.name}</div>
            <div class="muted" style="font-size:12px">${item.qty} √ó ${item.price} kr</div>
          </div>
          <button class="btn danger" style="padding:6px 10px;font-size:11px" onclick="removeFromCart('${item.id}')">Fjern</button>
        `;
        cartList.appendChild(row);
      });
      cartTotalEl.textContent = `${total} kr`;
      renderCartCount();
    }

    function toggleCart(){
      cartDrawer.style.display = cartDrawer.style.display==='flex' ? 'none' : 'flex';
      if(cartDrawer.style.display==='flex') renderCart();
    }
    function closeCart(){ cartDrawer.style.display='none'; }

    window.removeFromCart = removeFromCart;
    window.clearCart = clearCart;
    window.checkout = checkout;
    window.closeCart = closeCart;

    cartToggle.addEventListener('click', toggleCart);

    /* ================== ORDERS ================== */
    function getOrders(){ try{return JSON.parse(localStorage.getItem(LS.ORDERS)||'[]')}catch(_){return[]} }
    function saveOrders(o){ localStorage.setItem(LS.ORDERS, JSON.stringify(o)); }

    function checkout(){
      const cart = getCart();
      if(!cart.length) return toast('Din kurv er tom', false);
      const total = cart.reduce((s,i)=>s + (i.price||0)*(i.qty||1),0);
      const order = {
        id: 'ord_' + Math.random().toString(36).slice(2,10),
        createdAt: new Date().toISOString(),
        items: cart.map(c=>({id:c.id, name:c.name, price:c.price, qty:c.qty, image_url:c.image_url||null})),
        total
      };
      const orders = getOrders();
      orders.unshift(order);
      saveOrders(orders);
      localStorage.removeItem(LS.CART);
      renderCart();
      toast('Tak! Din ordre er modtaget.', true);
      closeCart();
    }

    /* ================== UI BUILDERS ================== */
    function createProductCard(p){
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <img src="${p.image_url||placeholderImg()}" alt="${p.name}">
        <div class="product-info">
          <div class="product-title">${p.name}</div>
          <div class="product-meta">Produkt-id: ${p.id}</div>
          <div class="price">${p.price} kr</div>
        </div>
      `;
      const btn = document.createElement('button');
      btn.className = 'buy-btn';
      btn.textContent = 'Tilf√∏j til kurv';
      btn.onclick = ()=> addToCart({ id:String(p.id), name:p.name, price:Number(p.price)||0, image_url:p.image_url });
      card.appendChild(btn);
      return card;
    }

    function createOfferCard(o){
      const card = document.createElement('div');
      card.className='offer-card';

      const row = document.createElement('div');
      row.className = 'offer-card-row';

      const img = document.createElement('img');
      img.src = o.image_url || placeholderImg();
      img.alt = o.title;
      img.className = 'offer-img';

      const info = document.createElement('div');
      info.className='offer-content';
      info.innerHTML = `
        <div class="offer-title">${o.title||o.name}</div>
        <div class="offer-desc">${o.description||''}</div>
      `;

      const right = document.createElement('div');
      right.className='offer-right';
      const priceEl = document.createElement('div');
      priceEl.className='price';
      priceEl.style.fontSize='14px';
      priceEl.textContent = (o.price!=null)?`${Number(o.price)} kr`:'';

      const addBtn = document.createElement('button');
      addBtn.className='buy-btn';
      addBtn.style.fontSize='12px';
      addBtn.textContent='Tilf√∏j';
      addBtn.onclick = ()=> addToCart({
        id:`offer-${o.id}`,
        name:o.title||o.name||`Tilbud ${o.id}`,
        price:Number(o.price)||0,
        image_url:o.image_url||null
      });

      right.appendChild(priceEl);
      right.appendChild(addBtn);

      row.appendChild(img);
      row.appendChild(info);
      row.appendChild(right);
      card.appendChild(row);

      return card;
    }

    function placeholderImg(){
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="800" height="500">
          <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#e5e7eb"/><stop offset="1" stop-color="#cbd5e1"/></linearGradient>
          </defs>
          <rect width="100%" height="100%" fill="url(#g)"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Inter,Arial" font-size="28" fill="#94a3b8">Billede</text>
        </svg>`);
    }

    /* ================== PROFILE ================== */
    function getProfile(){ try{return JSON.parse(localStorage.getItem(LS.PROFILE)||'{}')}catch(_){return{}} }
    function saveProfile(p){ localStorage.setItem(LS.PROFILE, JSON.stringify(p)); }

    /* ================== SECTIONS ================== */
    async function showSection(section){
      pageContent.innerHTML='';
      document.querySelectorAll('.bottom-nav button').forEach(b=>b.classList.remove('active'));
      const ab = document.querySelector(`.bottom-nav button[data-section="${section}"]`);
      if(ab) ab.classList.add('active');

      if(section==='store'){
        pageTitle.textContent='Butik';

        const header = document.createElement('div');
        header.className='section-row';
        header.innerHTML = `
          <div>
            <h3>Butik</h3>
            <div class="section-caption">Se sortimentet og l√¶g varer i kurven</div>
          </div>
        `;
        pageContent.appendChild(header);

        const searchWrap=document.createElement('div');
        searchWrap.className='search-box';
        searchWrap.innerHTML = "<input id='productSearch' placeholder='S√∏g efter produkter‚Ä¶' />";
        pageContent.appendChild(searchWrap);

        const spinner = document.createElement('div');
        spinner.className='muted';
        spinner.style.padding='6px 2px';
        spinner.textContent='Henter produkter‚Ä¶';
        pageContent.appendChild(spinner);

        const { data: products } = await fetchProducts();
        pageContent.removeChild(spinner);

        if(!products || products.length===0){
          const empty = document.createElement('div');
          empty.className='muted';
          empty.style.textAlign='center';
          empty.style.padding='18px';
          empty.textContent='Ingen produkter fundet.';
          pageContent.appendChild(empty);
          return;
        }

        await Promise.all(products.map(async p=>{
          if(p.image_url && !p.image_url.startsWith('http')) p.image_url = await resolveImageUrl(p.image_url);
          p.price = Number(p.price)||0;
          p.name = p.name || `Produkt ${p.id}`;
        }));

        let grid = document.createElement('div');  // <- let (so we can replace it)
        grid.className='product-grid';
        products.forEach(p=> grid.appendChild(createProductCard(p)));
        pageContent.appendChild(grid);

        // Search filter
        document.getElementById('productSearch').addEventListener('input', (e)=>{
          const q = e.target.value.toLowerCase().trim();
          const filtered = products.filter(p => (p.name||'').toLowerCase().includes(q));
          const newGrid=document.createElement('div');
          newGrid.className='product-grid';
          filtered.forEach(p=> newGrid.appendChild(createProductCard(p)));
          grid.replaceWith(newGrid);
          grid = newGrid;
        });
      }

      else if(section==='news'){
        pageTitle.textContent='Nyheder';
        const header = document.createElement('div');
        header.className='section-row';
        header.innerHTML=`
          <div>
            <h3>Nyheder</h3>
            <div class="section-caption">Aktuelle informationer og kampagner</div>
          </div>
        `;
        pageContent.appendChild(header);

        // Static news cards
        const newsContainer = document.createElement('div');
        newsContainer.style.display='grid';
        newsContainer.style.gridTemplateColumns='repeat(auto-fit,minmax(260px,1fr))';
        newsContainer.style.gap='12px';

        [
          {
            title:'√Öbningstider i dag',
            text:'Vi har √•bent kl. 07‚Äì20 p√• hverdage og 09‚Äì18 i weekenden.'
          },
          {
            title:'Nye produkter',
            text:'Pr√∏v vores nye veggie-sandwich og s√¶sonens varme drikke.'
          }
        ].forEach(n=>{
          const card = document.createElement('div');
          card.className='offer-card';
          card.style.alignItems='flex-start';
          card.innerHTML = `
            <div style="font-weight:700;font-size:14px;margin-bottom:4px">${n.title}</div>
            <div class="muted" style="font-size:13px">${n.text}</div>
          `;
          newsContainer.appendChild(card);
        });
        pageContent.appendChild(newsContainer);

        const offersHeader=document.createElement('div');
        offersHeader.className='section-row';
        offersHeader.style.marginTop='18px';
        offersHeader.innerHTML='<div><h3>Tilbud</h3><div class="section-caption">S√¶rlige kampagner og pakker</div></div>';
        pageContent.appendChild(offersHeader);

        const offers = await fetchOffers();
        const offersWrap = document.createElement('div');
        offersWrap.style.display='grid';
        offersWrap.style.gap='10px';

        if(!offers || offers.length===0){
          const noOffers=document.createElement('div');
          noOffers.className='offer-card';
          noOffers.innerHTML='<div class="muted">Ingen tilbud fundet.</div>';
          offersWrap.appendChild(noOffers);
        } else {
          await Promise.all(offers.map(async o=>{
            if(o.image_url && !o.image_url.startsWith('http')) o.image_url = await resolveImageUrl(o.image_url);
          }));
          offers.forEach(o=> offersWrap.appendChild(createOfferCard(o)));
        }
        pageContent.appendChild(offersWrap);
      }

      else if(section==='profile'){
        pageTitle.textContent='Profil';
        const header = document.createElement('div');
        header.className='section-row';
        header.innerHTML='<div><h3>Profil &amp; Indstillinger</h3><div class="section-caption">Opdater dine oplysninger og se ordrehistorik</div></div>';
        pageContent.appendChild(header);

        const { data: userResp } = await supabase.auth.getUser();
        const emailFromAuth = userResp?.user?.email || '';

        const profile = getProfile();

        const grid = document.createElement('div');
        grid.className = 'profile-grid';

        // Profile form
        const formCard = document.createElement('div');
        formCard.className='offer-card';
        formCard.style.alignItems='stretch';
        formCard.innerHTML = `
          <div style="display:grid; gap:12px; width:100%;">
            <div>
              <div class="field-label">Login-email</div>
              <div class="muted" style="margin-top:4px;font-size:13px;">${emailFromAuth || '<span class="muted">Ikke angivet</span>'}</div>
            </div>
            <label style="display:grid; gap:4px;">
              <span class="field-label">Navn</span>
              <input id="profileName" placeholder="Fx. Anna Hansen" value="${profile.name||''}">
            </label>
            <label style="display:grid; gap:4px;">
              <span class="field-label">Telefon</span>
              <input id="profilePhone" placeholder="+45 12 34 56 78" value="${profile.phone||''}">
            </label>
            <label style="display:grid; gap:4px;">
              <span class="field-label">Kontakt-email (valgfrit)</span>
              <input id="profileEmail" placeholder="fx. dig@brokiosken.dk" value="${profile.email||''}">
            </label>
            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:4px;">
              <button class="btn ghost" id="btnResetProfile">Nulstil</button>
              <button class="btn primary" id="btnSaveProfile">Gem profil</button>
            </div>
          </div>
        `;

        // Orders
        const ordersCard = document.createElement('div');
        ordersCard.className='offer-card';
        ordersCard.style.alignItems='stretch';

        const ordersHeaderRow = document.createElement('div');
        ordersHeaderRow.className='section-row';
        ordersHeaderRow.style.margin='0 0 8px';
        ordersHeaderRow.innerHTML='<div><span class="field-label">Dine ordrer</span></div>';

        const ordersWrap=document.createElement('div');
        ordersWrap.style.display='grid';
        ordersWrap.style.gap='8px';

        const orders=getOrders();
        if(!orders.length){
          const empty=document.createElement('div');
          empty.className='muted';
          empty.style.fontSize='13px';
          empty.textContent='Ingen ordrer endnu. K√∏b noget i butikken for at se din ordrehistorik her.';
          ordersWrap.appendChild(empty);
        } else {
          orders.forEach(o=>{
            const d=new Date(o.createdAt);
            const card=document.createElement('div');
            card.style.padding='8px 0';
            card.style.borderBottom='1px solid rgba(148,163,184,.35)';
            card.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
                <div>
                  <div style="font-weight:700;font-size:13px;">Ordre ${o.id}</div>
                  <div class="muted" style="font-size:12px;margin-top:2px;">${d.toLocaleDateString('da-DK', {year:'numeric',month:'short',day:'numeric', hour:'2-digit', minute:'2-digit'})}</div>
                  <div class="muted" style="margin-top:4px;font-size:12px;">
                    ${o.items.map(i=>`${i.qty}√ó ${i.name}`).slice(0,3).join(', ')}${o.items.length>3?' ‚Ä¶':''}
                  </div>
                </div>
                <div style="text-align:right">
                  <div style="font-weight:700;font-size:13px;">${o.total} kr</div>
                  <button class="btn ghost" style="margin-top:4px;font-size:11px;padding:5px 9px" onclick='showOrder("${o.id}")'>Detaljer</button>
                </div>
              </div>
            `;
            ordersWrap.appendChild(card);
          });
        }
        ordersCard.appendChild(ordersHeaderRow);
        ordersCard.appendChild(ordersWrap);

        grid.appendChild(formCard);
        grid.appendChild(ordersCard);
        pageContent.appendChild(grid);

        // Logout & local reset
        const actionsRow=document.createElement('div');
        actionsRow.style.display='flex';
        actionsRow.style.justifyContent='space-between';
        actionsRow.style.marginTop='14px';
        actionsRow.style.gap='10px';

        const left = document.createElement('div');
        left.className='muted';
        left.style.fontSize='12px';
        left.textContent='Data gemmes kun lokalt i din browser (profil og ordrer).';

        const right = document.createElement('div');
        right.style.display='flex';
        right.style.gap='8px';
        right.innerHTML = `
          <button class="btn ghost" onclick="resetLocalData()" style="font-size:12px;">Ryd lokale data</button>
          <button class="btn danger" onclick="logoutUser()" style="font-size:12px;">Log ud</button>
        `;

        actionsRow.appendChild(left);
        actionsRow.appendChild(right);
        pageContent.appendChild(actionsRow);

        // Wire profile actions
        document.getElementById('btnSaveProfile').addEventListener('click', ()=>{
          const name = (document.getElementById('profileName').value||'').trim();
          const phone= (document.getElementById('profilePhone').value||'').trim();
          const email = (document.getElementById('profileEmail').value||'').trim();
          saveProfile({name,phone,email});
          toast('‚úÖ Profil gemt', true);
        });
        document.getElementById('btnResetProfile').addEventListener('click', ()=>{
          document.getElementById('profileName').value='';
          document.getElementById('profilePhone').value='';
          document.getElementById('profileEmail').value='';
          saveProfile({});
          toast('Profil nulstillet', true);
        });
      }
    }
    window.showSection = showSection;

    /* Order details dialog */
    window.showOrder = (orderId)=>{
      const o = getOrders().find(x=>x.id===orderId);
      if(!o) return;
      const list = o.items.map(i=>`‚Ä¢ ${i.qty}√ó ${i.name} ‚Äî ${i.price} kr`).join('\n');
      openDialog({
        title:`Ordre ${o.id}`,
        body:`${new Date(o.createdAt).toLocaleString('da-DK')}\n\n${list}\n\nTotal: ${o.total} kr`,
        confirmText:'Luk',
        cancelText:''
      }).then(()=>{});
      dialogCancel.style.display='none';
      setTimeout(()=>dialogCancel.style.display='', 350);
    };

    async function logoutUser(){
      const ok = await openDialog({
        title:'Log ud',
        body:'Er du sikker p√• at du vil logge ud?',
        confirmText:'Log ud',
        cancelText:'Annuller'
      });
      if(!ok) return;
      await supabase.auth.signOut();
      window.location.href = LOGIN_PAGE_URL;
    }
    window.logoutUser = logoutUser;

    async function resetLocalData(){
      const ok = await openDialog({
        title:'Ryd lokale data',
        body:'Dette vil rydde kurv, profil og ordrehistorik, som er gemt i din browser.\n\nEr du sikker?',
        confirmText:'Ryd data',
        cancelText:'Annuller'
      });
      if(!ok) return;
      localStorage.removeItem(LS.CART);
      localStorage.removeItem(LS.PROFILE);
      localStorage.removeItem(LS.ORDERS);
      renderCartCount();
      toast('Lokal data ryddet.', true);
      showSection('store');
    }
    window.resetLocalData = resetLocalData;

    /* ================== INIT ================== */
    function init(){
      renderCartCount();
      showSection('store');
    }
  </script>
</body>
</html>
